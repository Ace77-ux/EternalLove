<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EchoVerse - è™šæ‹Ÿæ‰‹æœº</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“±</text></svg>">
/* style.css */
:root {
    /* ä¸»è‰²è°ƒ */
    --primary-color: #07C160;
    --primary-dark: #06AD56;
    --primary-light: #D5F4E2;
    
    /* è¾…åŠ©è‰² */
    --secondary-blue: #10AEFF;
    --secondary-orange: #FF9500;
    --secondary-purple: #AF52DE;
    
    /* è­¦ç¤ºè‰² */
    --danger-red: #FA5151;
    --warning-orange: #FA9D3B;
    --success-green: #07C160;
    --info-blue: #576B95;
    
    /* ä¸­æ€§è‰² */
    --text-primary: #000000;
    --text-secondary: #8E8E93;
    --text-tertiary: #C7C7CC;
    --text-disabled: #D1D1D6;
    
    --bg-primary: #FFFFFF;
    --bg-secondary: #F2F2F7;
    --bg-tertiary: #E5E5EA;
    
    --border-light: #E5E5EA;
    --border-medium: #C7C7CC;
    --border-dark: #8E8E93;
    
    /* é˜´å½± */
    --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.16);
    
    /* é—´è· */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 24px;
    --space-xxl: 32px;
    
    /* åœ†è§’ */
    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 18px;
    --radius-xl: 24px;
    --radius-full: 9999px;
    
    /* å­—ä½“ */
    --font-family: 'Inter', 'PingFang SC', -apple-system, sans-serif;
    --font-size-xs: 11px;
    --font-size-sm: 13px;
    --font-size-md: 15px;
    --font-size-lg: 17px;
    --font-size-xl: 22px;
    --font-size-xxl: 28px;
    --font-size-xxxl: 34px;
    
    /* åŠ¨ç”» */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
    
    /* å±‚çº§ */
    --z-status-bar: 9999;
    --z-modal: 9998;
    --z-toast: 9997;
    --z-app-bar: 9996;
    --z-floating: 9995;
}

/* é‡ç½®æ ·å¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    font-family: var(--font-family);
    font-size: var(--font-size-md);
    color: var(--text-primary);
    background: var(--bg-secondary);
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    position: fixed;
    user-select: none;
}

/* åº”ç”¨å®¹å™¨ */
.app-container {
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    background: var(--bg-primary);
    overflow: hidden;
}

.hidden {
    display: none !important;
}

.active {
    display: block !important;
}

/* çŠ¶æ€æ  */
.status-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 44px;
    background: rgba(0, 0, 0, 0.4);
    color: white;
    padding: 0 var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: var(--font-size-sm);
    font-weight: 600;
    z-index: var(--z-status-bar);
    backdrop-filter: blur(20px);
}

.status-left, .status-right {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.time {
    font-variant-numeric: tabular-nums;
}

/* ä¸»å±å¹• */
.launcher {
    padding-top: 44px;
    height: 100vh;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: background-image 0.3s ease;
    background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* åº”ç”¨ç½‘æ ¼ */
.app-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-xl);
    padding: var(--space-xl);
    padding-top: var(--space-xxl);
}

.app-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.app-icon:active {
    transform: scale(0.92);
    background: rgba(255, 255, 255, 0.1);
}

.app-icon-image {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    color: white;
    box-shadow: var(--shadow-sm);
}

.app-icon-name {
    font-size: var(--font-size-sm);
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ç¼–è¾‘æ¨¡å¼ */
.edit-mode .app-icon {
    animation: shake 0.5s ease-in-out infinite alternate;
}

@keyframes shake {
    0% { transform: rotate(-2deg) scale(1); }
    100% { transform: rotate(2deg) scale(1); }
}

.edit-mode .app-icon:active {
    animation: none;
}

/* æ¨¡æ€æ¡† */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
    opacity: 0;
    animation: fadeIn 0.2s ease forwards;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    transform: translateY(20px);
    animation: slideUp 0.3s ease forwards;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* åº•éƒ¨æ“ä½œèœå• */
.action-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    z-index: var(--z-modal);
    transform: translateY(100%);
    animation: slideUpBottom 0.3s ease forwards;
}

@keyframes slideUpBottom {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.action-sheet-item {
    padding: var(--space-lg);
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-light);
    text-align: center;
    font-size: var(--font-size-lg);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.action-sheet-item:active {
    background: var(--bg-secondary);
}

.action-sheet-item.danger {
    color: var(--danger-red);
}

.action-sheet-item.cancel {
    margin-top: var(--space-sm);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    padding: var(--space-md) var(--space-xl);
    border-radius: var(--radius-md);
    border: none;
    font-family: var(--font-family);
    font-size: var(--font-size-md);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:active:not(:disabled) {
    background: var(--primary-dark);
    transform: scale(0.98);
}

.btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
}

.btn-secondary:active:not(:disabled) {
    background: var(--bg-tertiary);
}

.btn-danger {
    background: var(--danger-red);
    color: white;
}

.btn-text {
    background: transparent;
    color: var(--info-blue);
    padding: var(--space-sm) var(--space-md);
}

.btn-text-danger {
    color: var(--danger-red);
}

/* è¾“å…¥æ¡† */
.input-group {
    margin-bottom: var(--space-lg);
}

.input-label {
    display: block;
    margin-bottom: var(--space-sm);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.input-field {
    width: 100%;
    padding: var(--space-md) var(--space-lg);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-family: var(--font-family);
    font-size: var(--font-size-md);
    color: var(--text-primary);
    background: var(--bg-primary);
    transition: border-color var(--transition-fast);
}

.input-field:focus {
    outline: none;
    border-color: var(--primary-color);
}

.input-field::placeholder {
    color: var(--text-tertiary);
}

.input-field.error {
    border-color: var(--danger-red);
    animation: shakeInput 0.3s ease;
}

@keyframes shakeInput {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}

/* æ»šåŠ¨æ¡ */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: var(--border-medium);
    border-radius: var(--radius-full);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--border-dark);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 320px) {
    .app-grid {
        gap: var(--space-lg);
        padding: var(--space-lg);
    }
    
    .app-icon-image {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
}

@media (min-width: 500px) {
    body {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .app-container {
        width: 375px;
        height: 812px;
        border-radius: 40px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        position: relative;
    }
}
</head>
<body>
    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="app-container">
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar" class="status-bar"></div>
        
        <!-- ä¸»å±å¹• -->
        <div id="launcher" class="launcher active"></div>
        
        <!-- èŠå¤©åº”ç”¨ -->
        <div id="chat-app" class="app-container hidden"></div>
        
        <!-- å•†åº—åº”ç”¨ -->
        <div id="store-app" class="app-container hidden"></div>
        
        <!-- ç›¸å†Œåº”ç”¨ -->
        <div id="gallery-app" class="app-container hidden"></div>
        
        <!-- ç›¸æœºåº”ç”¨ -->
        <div id="camera-app" class="app-container hidden"></div>
        
        <!-- çŸ­ä¿¡åº”ç”¨ -->
        <div id="sms-app" class="app-container hidden"></div>
        
        <!-- è®¾ç½®åº”ç”¨ -->
        <div id="settings-app" class="app-container hidden"></div>
        
        <!-- å…¨å±€æ¨¡æ€æ¡†å®¹å™¨ -->
        <div id="modal-container"></div>
        
        <!-- å…¨å±€æç¤ºå®¹å™¨ -->
        <div id="toast-container"></div>
    </div>

    <!-- è„šæœ¬æ–‡ä»¶ -->
// utils/storage.js
const EchoVerseStorage = {
    // æ•°æ®åº“é…ç½®
    DB_NAME: 'EchoVerseDB',
    DB_VERSION: 1,
    
    // åˆå§‹åŒ–æ•°æ®åº“
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve(this.db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // åˆ›å»ºå¯¹è±¡ä»“åº“
                if (!db.objectStoreNames.contains('users')) {
                    const userStore = db.createObjectStore('users', { keyPath: 'id' });
                    userStore.createIndex('echoId', 'echoId', { unique: true });
                }
                
                if (!db.objectStoreNames.contains('ai_friends')) {
                    const aiStore = db.createObjectStore('ai_friends', { keyPath: 'id' });
                    aiStore.createIndex('createdAt', 'createdAt');
                    aiStore.createIndex('isBlocked', 'isBlocked');
                }
                
                if (!db.objectStoreNames.contains('conversations')) {
                    db.createObjectStore('conversations', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('messages')) {
                    const msgStore = db.createObjectStore('messages', { keyPath: 'id' });
                    msgStore.createIndex('conversationId', 'conversationId');
                    msgStore.createIndex('timestamp', 'timestamp');
                }
                
                if (!db.objectStoreNames.contains('moments')) {
                    const momentStore = db.createObjectStore('moments', { keyPath: 'id' });
                    momentStore.createIndex('authorId', 'authorId');
                    momentStore.createIndex('timestamp', 'timestamp');
                }
                
                if (!db.objectStoreNames.contains('photos')) {
                    const photoStore = db.createObjectStore('photos', { keyPath: 'id' });
                    photoStore.createIndex('timestamp', 'timestamp', { unique: false });
                    photoStore.createIndex('type', 'type', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('shop_items')) {
                    db.createObjectStore('shop_items', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('inventory')) {
                    db.createObjectStore('inventory', { keyPath: 'itemId' });
                }
                
                if (!db.objectStoreNames.contains('system')) {
                    db.createObjectStore('system', { keyPath: 'key' });
                }
            };
        });
    },
    
    // é€šç”¨CRUDæ“ä½œ
    async add(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    async get(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    async getAll(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    async update(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    async delete(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(key);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    async query(storeName, indexName, value) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index(indexName);
            const request = index.getAll(value);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    // ç”¨æˆ·æ•°æ®æ“ä½œ
    async getUser() {
        let user = await this.get('users', 'user_local');
        
        if (!user) {
            // åˆ›å»ºé»˜è®¤ç”¨æˆ·
            user = {
                id: 'user_local',
                profile: {
                    nickname: 'EchoVerseç”¨æˆ·',
                    avatar: null,
                    echoId: this.generateEchoId(),
                    echoIdLastChanged: Date.now()
                },
                wallet: {
                    balance: 1000,
                    history: []
                },
                settings: {
                    notifications: true,
                    privacy: {
                        showOnlineStatus: true,
                        allowAIInitiate: true
                    }
                },
                createdAt: Date.now()
            };
            
            await this.add('users', user);
        }
        
        return user;
    },
    
    async updateUser(updates) {
        const user = await this.getUser();
        const updatedUser = { ...user, ...updates };
        return this.update('users', updatedUser);
    },
    
    // AIå¥½å‹æ“ä½œ
    async getAIFriends() {
        const friends = await this.getAll('ai_friends');
        return friends.sort((a, b) => b.createdAt - a.createdAt);
    },
    
    async getAIFriend(id) {
        return this.get('ai_friends', id);
    },
    
    async createAIFriend(data) {
        const aiFriend = {
            id: `ai_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            profile: {
                name: data.name || 'æœªå‘½åAI',
                avatar: data.avatar || this.generateRandomAvatar(data.name),
                banner: data.banner || this.generateRandomGradient(),
                basicInfo: {
                    gender: data.gender || 'unspecified',
                    age: data.age || null,
                    occupation: data.occupation || null,
                    zodiac: data.zodiac || null,
                    location: data.location || null,
                    personalityTags: data.personalityTags || [],
                    customTags: data.customTags || [],
                    signature: data.signature || null
                }
            },
            character: {
                systemPrompt: data.systemPrompt || '',
                exampleDialogues: data.exampleDialogues || [],
                personalityTraits: data.personalityTraits || {
                    warmth: 0.8,
                    humor: 0.6,
                    curiosity: 0.9,
                    empathy: 0.7,
                    dominance: 0.3
                },
                speechStyle: data.speechStyle || {
                    formality: 0.4,
                    wordiness: 0.6,
                    useEmojis: true,
                    catchphrases: []
                }
            },
            apiConfig: data.apiConfig || {
                provider: 'openai',
                endpoint: 'https://api.openai.com/v1/chat/completions',
                apiKey: '',
                model: 'gpt-3.5-turbo',
                parameters: {
                    temperature: 0.8,
                    maxTokens: 2000,
                    topP: 1,
                    frequencyPenalty: 0,
                    presencePenalty: 0,
                    stopSequences: [],
                    stream: true
                }
            },
            behavior: data.behavior || {
                initiative: {
                    frequency: 'medium',
                    triggers: ['login', 'idle', 'time_based'],
                    preferredHours: [9, 12, 18, 21],
                    topics: ['greeting', 'sharing', 'question', 'care']
                },
                moments: {
                    enabled: true,
                    frequency: 'daily',
                    contentTypes: ['text', 'image'],
                    autoGenerate: true,
                    allowUserPost: true
                }
            },
            state: {
                isConfigured: Boolean(data.systemPrompt && data.apiConfig?.apiKey),
                isBlocked: false,
                isActive: true,
                totalMessages: 0,
                lastMessageTime: null,
                createdAt: Date.now()
            },
            chatHistory: [],
            momentIds: [],
            smsHistory: []
        };
        
        await this.add('ai_friends', aiFriend);
        return aiFriend;
    },
    
    async updateAIFriend(id, updates) {
        const aiFriend = await this.getAIFriend(id);
        if (!aiFriend) throw new Error('AIå¥½å‹ä¸å­˜åœ¨');
        
        const updatedAI = { ...aiFriend, ...updates };
        return this.update('ai_friends', updatedAI);
    },
    
    async deleteAIFriend(id) {
        // åˆ é™¤AIå¥½å‹
        await this.delete('ai_friends', id);
        
        // åˆ é™¤ç›¸å…³æ¶ˆæ¯
        const messages = await this.query('messages', 'conversationId', `conv_${id}`);
        for (const msg of messages) {
            await this.delete('messages', msg.id);
        }
        
        // åˆ é™¤ç›¸å…³çŸ­ä¿¡
        // TODO: çŸ­ä¿¡åˆ é™¤é€»è¾‘
    },
    
    // æ¶ˆæ¯æ“ä½œ
    async getMessages(conversationId, limit = 50, before = null) {
        let messages = await this.query('messages', 'conversationId', conversationId);
        
        // æŒ‰æ—¶é—´æ’åº
        messages.sort((a, b) => a.timestamp - b.timestamp);
        
        // åˆ†é¡µ
        if (before) {
            const beforeIndex = messages.findIndex(m => m.id === before);
            if (beforeIndex > -1) {
                messages = messages.slice(0, beforeIndex);
            }
        }
        
        return messages.slice(-limit);
    },
    
    async addMessage(message) {
        const msg = {
            id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            conversationId: message.conversationId,
            sender: message.sender,
            content: message.content,
            type: message.type || 'text',
            media: message.media || null,
            status: message.status || 'sent',
            timestamp: Date.now(),
            recalled: false,
            recallTime: null
        };
        
        await this.add('messages', msg);
        
        // æ›´æ–°å¯¹è¯çš„æœ€åæ¶ˆæ¯æ—¶é—´
        const aiId = message.conversationId.replace('conv_', '');
        await this.updateAIFriend(aiId, {
            'state.lastMessageTime': Date.now(),
            'state.totalMessages': await this.getMessageCount(aiId)
        });
        
        return msg;
    },
    
    async getMessageCount(aiId) {
        const messages = await this.query('messages', 'conversationId', `conv_${aiId}`);
        return messages.length;
    },
    
    // ç›¸å†Œæ“ä½œ
    async getPhotos(limit = 50, offset = 0) {
        const photos = await this.getAll('photos');
        photos.sort((a, b) => b.timestamp - a.timestamp);
        return photos.slice(offset, offset + limit);
    },
    
    async addPhoto(photoData) {
        const photo = {
            id: `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            type: photoData.type || 'photo',
            data: photoData.data,
            thumbnail: photoData.thumbnail || photoData.data,
            width: photoData.width || 800,
            height: photoData.height || 600,
            timestamp: Date.now(),
            source: photoData.source || 'camera'
        };
        
        await this.add('photos', photo);
        return photo;
    },
    
    // æ¯æ—¥é™åˆ¶ç®¡ç†
    async getDailyLimits() {
        const today = new Date().toDateString();
        const limits = await this.get('system', 'daily_limits');
        
        if (!limits || limits.date !== today) {
            // é‡ç½®æ¯æ—¥é™åˆ¶
            const newLimits = {
                key: 'daily_limits',
                date: today,
                limits: {
                    messages_sent: 0,
                    images_sent: 0,
                    gifts_sent: 0,
                    moments_posted: 0,
                    gifts_accumulated: 0
                },
                tasks: {
                    login: false,
                    chat_10_completed: []
                }
            };
            
            // æ£€æŸ¥ç´¯è®¡ç¤¼ç‰©æ¬¡æ•°æ˜¯å¦ä¿ç•™
            if (limits && limits.limits.gifts_accumulated < 5) {
                newLimits.limits.gifts_accumulated = limits.limits.gifts_accumulated;
            }
            
            await this.update('system', newLimits);
            return newLimits;
        }
        
        return limits;
    },
    
    async updateDailyLimits(updates) {
        const limits = await this.getDailyLimits();
        const updatedLimits = {
            ...limits,
            limits: { ...limits.limits, ...updates.limits },
            tasks: { ...limits.tasks, ...updates.tasks }
        };
        
        return this.update('system', updatedLimits);
    },
    
    // å·¥å…·å‡½æ•°
    generateEchoId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    },
    
    generateRandomAvatar(name) {
        // ç”ŸæˆåŸºäºåå­—çš„éšæœºé¢œè‰²
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'A';
        const colorIndex = name ? name.charCodeAt(0) % colors.length : 0;
        
        return {
            type: 'emoji',
            content: firstLetter,
            backgroundColor: colors[colorIndex]
        };
    },
    
    generateRandomGradient() {
        const gradients = [
            ['#667eea', '#764ba2'],
            ['#f093fb', '#f5576c'],
            ['#4facfe', '#00f2fe'],
            ['#43e97b', '#38f9d7'],
            ['#fa709a', '#fee140']
        ];
        
        const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];
        
        return {
            type: 'color',
            gradient: randomGradient
        };
    },
    
    // åŠ å¯†è§£å¯†ï¼ˆç®€å•ç‰ˆï¼‰
    encrypt(text) {
        // åœ¨å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„åŠ å¯†æ–¹æ³•
        return btoa(encodeURIComponent(text));
    },
    
    decrypt(encrypted) {
        try {
            return decodeURIComponent(atob(encrypted));
        } catch (e) {
            return '';
        }
    },
    
    // å¤‡ä»½å’Œæ¢å¤
    async exportData() {
        const data = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            users: await this.getAll('users'),
            ai_friends: await this.getAll('ai_friends'),
            messages: await this.getAll('messages'),
            moments: await this.getAll('moments'),
            photos: await this.getAll('photos'),
            inventory: await this.getAll('inventory')
        };
        
        return JSON.stringify(data);
    },
    
    async importData(jsonString) {
        const data = JSON.parse(jsonString);
        
        if (data.version !== '1.0') {
            throw new Error('ä¸æ”¯æŒçš„å¤‡ä»½ç‰ˆæœ¬');
        }
        
        // å¤‡ä»½å½“å‰æ•°æ®
        const backup = await this.exportData();
        
        try {
            // æ¸…ç©ºæ•°æ®åº“
            const storeNames = [
                'users', 'ai_friends', 'messages', 
                'moments', 'photos', 'inventory'
            ];
            
            for (const storeName of storeNames) {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                await store.clear();
            }
            
            // å¯¼å…¥æ–°æ•°æ®
            for (const storeName in data) {
                if (storeName !== 'version' && storeName !== 'exportDate') {
                    const items = data[storeName];
                    for (const item of items) {
                        await this.add(storeName, item);
                    }
                }
            }
            
            return true;
        } catch (error) {
            // æ¢å¤å¤‡ä»½
            await this.importData(backup);
            throw error;
        }
    }
};
// utils/helpers.js
const EchoVerseHelpers = {
    // æ ¼å¼åŒ–æ—¶é—´
    formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        // åˆšåˆš
        if (diff < 60 * 1000) {
            return 'åˆšåˆš';
        }
        
        // Xåˆ†é’Ÿå‰
        if (diff < 60 * 60 * 1000) {
            return `${Math.floor(diff / (60 * 1000))}åˆ†é’Ÿå‰`;
        }
        
        // Xå°æ—¶å‰
        if (diff < 24 * 60 * 60 * 1000) {
            return `${Math.floor(diff / (60 * 60 * 1000))}å°æ—¶å‰`;
        }
        
        // æ˜¨å¤©
        if (diff < 48 * 60 * 60 * 1000) {
            return 'æ˜¨å¤©';
        }
        
        // Xå¤©å‰
        if (diff < 7 * 24 * 60 * 60 * 1000) {
            return `${Math.floor(diff / (24 * 60 * 60 * 1000))}å¤©å‰`;
        }
        
        // å®Œæ•´æ—¥æœŸ
        return `${date.getMonth() + 1}-${date.getDate()}`;
    },
    
    // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´
    formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    },
    
    // ç”Ÿæˆéšæœºé¢œè‰²
    generateRandomColor() {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
            '#FFEAA7', '#DDA0DD', '#FFD93D', '#6BCF7F',
            '#4D96FF', '#C780E8'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    },
    
    // è®¡ç®—æ–‡æœ¬é•¿åº¦ï¼ˆä¸­è‹±æ–‡æ··åˆï¼‰
    getTextLength(text) {
        let length = 0;
        for (let i = 0; i < text.length; i++) {
            const charCode = text.charCodeAt(i);
            // ä¸­æ–‡å­—ç¬¦ç®—2ä¸ªé•¿åº¦
            if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                length += 2;
            } else {
                length += 1;
            }
        }
        return length;
    },
    
    // æˆªæ–­æ–‡æœ¬
    truncateText(text, maxLength, suffix = '...') {
        if (this.getTextLength(text) <= maxLength) return text;
        
        let result = '';
        let currentLength = 0;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const charCode = text.charCodeAt(i);
            
            if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                currentLength += 2;
            } else {
                currentLength += 1;
            }
            
            if (currentLength > maxLength) {
                break;
            }
            
            result += char;
        }
        
        return result + suffix;
    },
    
    // é˜²æŠ–å‡½æ•°
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    
    // èŠ‚æµå‡½æ•°
    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    },
    
    // æ·±æ‹·è´
    deepCopy(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj instanceof Date) return new Date(obj.getTime());
        if (obj instanceof Array) return obj.map(item => this.deepCopy(item));
        if (typeof obj === 'object') {
            const copied = {};
            for (const key in obj) {
                copied[key] = this.deepCopy(obj[key]);
            }
            return copied;
        }
    },
    
    // ç”Ÿæˆå”¯ä¸€ID
    generateId(prefix = '') {
        return `${prefix}${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },
    
    // æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒä½åˆ†éš”ç¬¦ï¼‰
    formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    },
    
    // å›¾ç‰‡å‹ç¼©
    async compressImage(file, maxWidth = 800, quality = 0.8) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½¬æ¢ä¸ºbase64
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedBase64);
                };
                
                img.onerror = reject;
            };
            
            reader.onerror = reject;
        });
    },
    
    // åˆ›å»ºç¼©ç•¥å›¾
    async createThumbnail(base64, size = 100) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = base64;
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                
                const ctx = canvas.getContext('2d');
                
                // è®¡ç®—è£å‰ªæ¯”ä¾‹
                const ratio = Math.min(size / img.width, size / img.height);
                const centerShiftX = (size - img.width * ratio) / 2;
                const centerShiftY = (size - img.height * ratio) / 2;
                
                ctx.drawImage(img, 0, 0, img.width, img.height,
                            centerShiftX, centerShiftY,
                            img.width * ratio, img.height * ratio);
                
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            
            img.onerror = reject;
        });
    },
    
    // æ˜¾ç¤ºToastæç¤º
    showToast(message, type = 'info', duration = 2000) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                ${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹'}
            </div>
            <div class="toast-message">${message}</div>
        `;
        
        container.appendChild(toast);
        
        // æ·»åŠ åŠ¨ç”»
        setTimeout(() => toast.classList.add('show'), 10);
        
        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, duration);
    },
    
    // åˆ›å»ºæ¨¡æ€æ¡†
    createModal(options) {
        const {
            title,
            content,
            buttons = [],
            onClose = () => {}
        } = options;
        
        const modalId = `modal_${Date.now()}`;
        const modalHtml = `
            <div class="modal-overlay" id="${modalId}">
                <div class="modal-content">
                    ${title ? `<div class="modal-header">${title}</div>` : ''}
                    <div class="modal-body">${content}</div>
                    ${buttons.length > 0 ? `
                        <div class="modal-footer">
                            ${buttons.map((btn, index) => `
                                <button class="btn ${btn.class || 'btn-secondary'}"
                                        data-action="${btn.action || 'close'}"
                                        data-index="${index}">
                                    ${btn.text}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        const container = document.getElementById('modal-container');
        if (!container) return null;
        
        container.innerHTML = modalHtml;
        const modal = document.getElementById(modalId);
        
        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        modal.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                const index = e.target.dataset.index;
                
                if (action === 'close') {
                    this.closeModal(modalId);
                    onClose();
                } else if (buttons[index] && buttons[index].onClick) {
                    buttons[index].onClick();
                }
            });
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        modal.querySelector('.modal-overlay').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                this.closeModal(modalId);
                onClose();
            }
        });
        
        return modalId;
    },
    
    // å…³é—­æ¨¡æ€æ¡†
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('closing');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
    },
    
    // åˆ›å»ºåº•éƒ¨æ“ä½œèœå•
    createActionSheet(options) {
        const { title, items, onClose = () => {} } = options;
        
        const sheetId = `sheet_${Date.now()}`;
        let sheetHtml = '<div class="action-sheet" id="' + sheetId + '">';
        
        if (title) {
            sheetHtml += `<div class="action-sheet-title">${title}</div>`;
        }
        
        items.forEach((item, index) => {
            sheetHtml += `
                <div class="action-sheet-item ${item.danger ? 'danger' : ''}"
                     data-index="${index}">
                    ${item.text}
                </div>
            `;
        });
        
        sheetHtml += `
            <div class="action-sheet-item cancel" data-action="cancel">
                å–æ¶ˆ
            </div>
        </div>
        `;
        
        const container = document.getElementById('modal-container');
        if (!container) return null;
        
        container.innerHTML = sheetHtml;
        const sheet = document.getElementById(sheetId);
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        sheet.querySelectorAll('.action-sheet-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const index = e.target.dataset.index;
                const action = e.target.dataset.action;
                
                if (action === 'cancel') {
                    this.closeActionSheet(sheetId);
                    onClose();
                } else if (index !== undefined && items[index] && items[index].onClick) {
                    items[index].onClick();
                    this.closeActionSheet(sheetId);
                }
            });
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        sheet.addEventListener('click', (e) => {
            if (e.target === sheet) {
                this.closeActionSheet(sheetId);
                onClose();
            }
        });
        
        return sheetId;
    },
    
    // å…³é—­åº•éƒ¨æ“ä½œèœå•
    closeActionSheet(sheetId) {
        const sheet = document.getElementById(sheetId);
        if (sheet) {
            sheet.classList.add('closing');
            setTimeout(() => {
                if (sheet.parentNode) {
                    sheet.parentNode.removeChild(sheet);
                }
            }, 300);
        }
    }
};
    // components/status-bar.js
class StatusBar {
    constructor() {
        this.container = null;
        this.timeElement = null;
        this.weatherElement = null;
        this.updateInterval = null;
        this.weatherData = null;
    }
    
    // åˆå§‹åŒ–çŠ¶æ€æ 
    async init(containerId = 'status-bar') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        this.render();
        this.startUpdating();
        
        // å°è¯•è·å–å¤©æ°”ä¿¡æ¯
        await this.updateWeather();
    }
    
    // æ¸²æŸ“çŠ¶æ€æ 
    render() {
        const currentTime = this.getCurrentTime();
        const weatherText = this.getWeatherText();
        
        this.container.innerHTML = `
            <div class="status-left">
                <span class="time">${currentTime}</span>
                <span class="signal">ğŸ“¶</span>
                <span class="carrier">EchoVerse</span>
            </div>
            <div class="status-right">
                <span class="weather">${weatherText}</span>
            </div>
        `;
        
        this.timeElement = this.container.querySelector('.time');
        this.weatherElement = this.container.querySelector('.weather');
    }
    
    // è·å–å½“å‰æ—¶é—´
    getCurrentTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }
    
    // è·å–å¤©æ°”æ–‡æœ¬
    getWeatherText() {
        if (this.weatherData) {
            const icon = this.getWeatherIcon(this.weatherData.description);
            return `${icon} ${this.weatherData.temp}Â°C ${this.weatherData.city}`;
        }
        return "â˜€ï¸ ç¦»çº¿";
    }
    
    // è·å–å¤©æ°”å›¾æ ‡
    getWeatherIcon(description) {
        const icons = {
            'æ™´': 'â˜€ï¸',
            'å¤šäº‘': 'â›…',
            'é˜´': 'â˜ï¸',
            'é›¨': 'ğŸŒ§ï¸',
            'é›ª': 'â„ï¸',
            'é›¾': 'ğŸŒ«ï¸',
            'é›·é˜µé›¨': 'â›ˆï¸'
        };
        
        for (const [key, icon] of Object.entries(icons)) {
            if (description.includes(key)) {
                return icon;
            }
        }
        
        return 'ğŸŒ¤ï¸';
    }
    
    // å¼€å§‹æ›´æ–°æ—¶é—´
    startUpdating() {
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        this.updateTime();
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
        this.updateInterval = setInterval(() => {
            this.updateTime();
        }, 1000);
        
        // æ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡å¤©æ°”
        setInterval(() => {
            this.updateWeather();
        }, 30 * 60 * 1000);
    }
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    updateTime() {
        if (this.timeElement) {
            this.timeElement.textContent = this.getCurrentTime();
        }
    }
    
    // æ›´æ–°å¤©æ°”ä¿¡æ¯
    async updateWeather() {
        try {
            // å°è¯•è·å–åœ°ç†ä½ç½®
            if (navigator.geolocation) {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        timeout: 5000,
                        maximumAge: 600000 // 10åˆ†é’Ÿç¼“å­˜
                    });
                });
                
                // è·å–å¤©æ°”æ•°æ®ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…é¡¹ç›®éœ€è¦è°ƒç”¨APIï¼‰
                this.weatherData = await this.fetchWeatherData(
                    position.coords.latitude,
                    position.coords.longitude
                );
                
                if (this.weatherElement) {
                    this.weatherElement.textContent = this.getWeatherText();
                }
            }
        } catch (error) {
            console.log('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:', error);
            // ä½¿ç”¨é»˜è®¤å¤©æ°”æ•°æ®
            this.weatherData = {
                temp: 24,
                description: 'æ™´',
                city: 'åŒ—äº¬'
            };
            
            if (this.weatherElement) {
                this.weatherElement.textContent = this.getWeatherText();
            }
        }
    }
    
    // è·å–å¤©æ°”æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
    async fetchWeatherData(lat, lon) {
        // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨å¤©æ°”API
        // ä¾‹å¦‚ï¼šhttps://api.openweathermap.org/data/2.5/weather
        // è¿™é‡Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
        
        // æ ¹æ®æ—¶é—´æ¨¡æ‹Ÿä¸åŒå¤©æ°”
        const now = new Date();
        const hour = now.getHours();
        
        let weather;
        if (hour >= 6 && hour < 18) {
            weather = ['æ™´', 'å¤šäº‘', 'æ™´è½¬å¤šäº‘'][Math.floor(Math.random() * 3)];
        } else {
            weather = ['æ™´', 'å¤šäº‘', 'é˜´'][Math.floor(Math.random() * 3)];
        }
        
        // æ¨¡æ‹Ÿæ¸©åº¦ï¼ˆ15-30åº¦ä¹‹é—´ï¼‰
        const temp = Math.floor(15 + Math.random() * 15);
        
        // æ¨¡æ‹ŸåŸå¸‚ï¼ˆæ ¹æ®ç²—ç•¥ä½ç½®ï¼‰
        const cities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½'];
        const cityIndex = Math.floor(Math.random() * cities.length);
        
        return {
            temp: temp,
            description: weather,
            city: cities[cityIndex]
        };
    }
    
    // é”€æ¯çŠ¶æ€æ 
    destroy() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }
}
// components/launcher.js
class Launcher {
    constructor() {
        this.container = null;
        this.appGrid = null;
        this.isEditMode = false;
        this.draggedIcon = null;
        this.appIcons = [
            {
                id: 'chat',
                name: 'èŠå¤©',
                icon: 'EL',
                color: '#07C160',
                appId: 'chat-app'
            },
            {
                id: 'store',
                name: 'å•†åº—',
                icon: 'ğŸ›ï¸',
                color: '#FF9500',
                appId: 'store-app'
            },
            {
                id: 'gallery',
                name: 'ç›¸å†Œ',
                icon: 'ğŸ–¼ï¸',
                color: '#AF52DE',
                appId: 'gallery-app'
            },
            {
                id: 'camera',
                name: 'ç›¸æœº',
                icon: 'ğŸ“·',
                color: '#007AFF',
                appId: 'camera-app'
            },
            {
                id: 'sms',
                name: 'çŸ­ä¿¡',
                icon: 'ğŸ’¬',
                color: '#34C759',
                appId: 'sms-app'
            },
            {
                id: 'settings',
                name: 'è®¾ç½®',
                icon: 'âš™ï¸',
                color: '#8E8E93',
                appId: 'settings-app'
            }
        ];
        
        // å£çº¸è®¾ç½®
        this.wallpaper = {
            type: 'gradient',
            value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        };
        
        // é•¿æŒ‰è®¡æ—¶å™¨
        this.longPressTimer = null;
    }
    
    // åˆå§‹åŒ–ä¸»å±å¹•
    async init(containerId = 'launcher') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // åŠ è½½å£çº¸è®¾ç½®
        await this.loadWallpaper();
        
        // æ¸²æŸ“ä¸»å±å¹•
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // åŠ è½½å£çº¸è®¾ç½®
    async loadWallpaper() {
        try {
            const wallpaperData = await EchoVerseStorage.get('system', 'wallpaper');
            if (wallpaperData) {
                this.wallpaper = wallpaperData;
            }
        } catch (error) {
            console.log('åŠ è½½å£çº¸å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å£çº¸');
        }
    }
    
    // ä¿å­˜å£çº¸è®¾ç½®
    async saveWallpaper() {
        await EchoVerseStorage.update('system', {
            key: 'wallpaper',
            ...this.wallpaper
        });
    }
    
    // æ¸²æŸ“ä¸»å±å¹•
    render() {
        // è®¾ç½®å£çº¸
        this.container.style.background = this.wallpaper.value;
        
        // åˆ›å»ºåº”ç”¨ç½‘æ ¼
        this.appGrid = document.createElement('div');
        this.appGrid.className = 'app-grid';
        
        // æ·»åŠ åº”ç”¨å›¾æ ‡
        this.appIcons.forEach(app => {
            const appIcon = this.createAppIcon(app);
            this.appGrid.appendChild(appIcon);
        });
        
        this.container.appendChild(this.appGrid);
    }
    
    // åˆ›å»ºåº”ç”¨å›¾æ ‡
    createAppIcon(app) {
        const iconContainer = document.createElement('div');
        iconContainer.className = 'app-icon';
        iconContainer.dataset.appId = app.id;
        
        // å›¾æ ‡
        const iconElement = document.createElement('div');
        iconElement.className = 'app-icon-image';
        iconElement.style.backgroundColor = app.color;
        iconElement.textContent = app.icon;
        
        // åç§°
        const nameElement = document.createElement('div');
        nameElement.className = 'app-icon-name';
        nameElement.textContent = app.name;
        
        iconContainer.appendChild(iconElement);
        iconContainer.appendChild(nameElement);
        
        return iconContainer;
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // ç‚¹å‡»åº”ç”¨å›¾æ ‡
        this.container.addEventListener('click', (e) => {
            const appIcon = e.target.closest('.app-icon');
            if (appIcon && !this.isEditMode) {
                const appId = appIcon.dataset.appId;
                this.openApp(appId);
            } else if (this.isEditMode) {
                // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ç‚¹å‡»ç©ºç™½å¤„é€€å‡ºç¼–è¾‘æ¨¡å¼
                this.exitEditMode();
            }
        });
        
        // é•¿æŒ‰åº”ç”¨å›¾æ ‡
        this.container.addEventListener('mousedown', this.handleLongPress.bind(this));
        this.container.addEventListener('touchstart', this.handleLongPress.bind(this));
        
        this.container.addEventListener('mouseup', this.cancelLongPress.bind(this));
        this.container.addEventListener('touchend', this.cancelLongPress.bind(this));
        this.container.addEventListener('touchcancel', this.cancelLongPress.bind(this));
        
        // æ‹–åŠ¨å›¾æ ‡
        this.container.addEventListener('dragstart', this.handleDragStart.bind(this));
        this.container.addEventListener('dragover', this.handleDragOver.bind(this));
        this.container.addEventListener('drop', this.handleDrop.bind(this));
        this.container.addEventListener('dragend', this.handleDragEnd.bind(this));
        
        // é•¿æŒ‰ç©ºç™½å¤„æ›´æ¢å£çº¸
        this.container.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    }
    
    // å¤„ç†é•¿æŒ‰
    handleLongPress(e) {
        // é˜»æ­¢é»˜è®¤è¡Œä¸º
        e.preventDefault();
        
        // æ‰¾åˆ°ç›®æ ‡åº”ç”¨å›¾æ ‡
        const appIcon = e.target.closest('.app-icon');
        if (!appIcon) return;
        
        // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
        this.cancelLongPress();
        
        // å¼€å§‹è®¡æ—¶
        this.longPressTimer = setTimeout(() => {
            this.enterEditMode(appIcon);
        }, 800); // 800æ¯«ç§’é•¿æŒ‰
    }
    
    // å–æ¶ˆé•¿æŒ‰
    cancelLongPress() {
        if (this.longPressTimer) {
            clearTimeout(this.longPressTimer);
            this.longPressTimer = null;
        }
    }
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    enterEditMode(clickedIcon = null) {
        this.isEditMode = true;
        this.container.classList.add('edit-mode');
        
        // æ˜¾ç¤ºç¼–è¾‘æç¤º
        this.showEditHint();
        
        // å¦‚æœæœ‰è¢«ç‚¹å‡»çš„å›¾æ ‡ï¼Œæ·»åŠ æ”¾å¤§æ•ˆæœ
        if (clickedIcon) {
            clickedIcon.classList.add('dragging');
        }
    }
    
    // é€€å‡ºç¼–è¾‘æ¨¡å¼
    exitEditMode() {
        this.isEditMode = false;
        this.container.classList.remove('edit-mode');
        
        // ç§»é™¤æ‰€æœ‰æ‹–åŠ¨æ ·å¼
        const icons = this.container.querySelectorAll('.app-icon');
        icons.forEach(icon => {
            icon.classList.remove('dragging');
        });
        
        // éšè—ç¼–è¾‘æç¤º
        this.hideEditHint();
    }
    
    // æ˜¾ç¤ºç¼–è¾‘æç¤º
    showEditHint() {
        const hint = document.createElement('div');
        hint.className = 'edit-hint';
        hint.textContent = 'æ‹–åŠ¨ä»¥é‡æ–°æ’åˆ—åº”ç”¨';
        hint.style.cssText = `
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            z-index: 10000;
        `;
        
        hint.id = 'edit-hint';
        this.container.appendChild(hint);
    }
    
    // éšè—ç¼–è¾‘æç¤º
    hideEditHint() {
        const hint = document.getElementById('edit-hint');
        if (hint && hint.parentNode) {
            hint.parentNode.removeChild(hint);
        }
    }
    
    // å¤„ç†æ‹–åŠ¨å¼€å§‹
    handleDragStart(e) {
        if (!this.isEditMode) return;
        
        const appIcon = e.target.closest('.app-icon');
        if (!appIcon) return;
        
        this.draggedIcon = appIcon;
        e.dataTransfer.setData('text/plain', appIcon.dataset.appId);
        e.dataTransfer.effectAllowed = 'move';
        
        // æ·»åŠ åŠé€æ˜æ•ˆæœ
        setTimeout(() => {
            appIcon.classList.add('dragging');
        }, 0);
    }
    
    // å¤„ç†æ‹–åŠ¨æ‚¬åœ
    handleDragOver(e) {
        if (!this.isEditMode || !this.draggedIcon) return;
        
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const targetIcon = e.target.closest('.app-icon');
        if (targetIcon && targetIcon !== this.draggedIcon) {
            this.swapIcons(this.draggedIcon, targetIcon);
        }
    }
    
    // å¤„ç†æ”¾ç½®
    handleDrop(e) {
        if (!this.isEditMode) return;
        
        e.preventDefault();
        const appId = e.dataTransfer.getData('text/plain');
        
        // æ›´æ–°åº”ç”¨é¡ºåº
        const newOrder = [];
        const icons = this.container.querySelectorAll('.app-icon');
        icons.forEach(icon => {
            newOrder.push(icon.dataset.appId);
        });
        
        // ä¿å­˜é¡ºåºåˆ°æœ¬åœ°å­˜å‚¨
        this.saveAppOrder(newOrder);
    }
    
    // å¤„ç†æ‹–åŠ¨ç»“æŸ
    handleDragEnd(e) {
        if (!this.isEditMode) return;
        
        // ç§»é™¤æ‹–åŠ¨æ ·å¼
        const icons = this.container.querySelectorAll('.app-icon');
        icons.forEach(icon => {
            icon.classList.remove('dragging');
        });
        
        this.draggedIcon = null;
    }
    
    // äº¤æ¢å›¾æ ‡ä½ç½®
    swapIcons(icon1, icon2) {
        const parent = icon1.parentNode;
        const index1 = Array.from(parent.children).indexOf(icon1);
        const index2 = Array.from(parent.children).indexOf(icon2);
        
        if (index1 < index2) {
            parent.insertBefore(icon2, icon1);
        } else {
            parent.insertBefore(icon1, icon2);
        }
    }
    
    // ä¿å­˜åº”ç”¨é¡ºåº
    saveAppOrder(order) {
        // æ›´æ–°å†…å­˜ä¸­çš„é¡ºåº
        this.appIcons.sort((a, b) => {
            return order.indexOf(a.id) - order.indexOf(b.id);
        });
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('echoVerse_appOrder', JSON.stringify(order));
    }
    
    // åŠ è½½åº”ç”¨é¡ºåº
    loadAppOrder() {
        try {
            const order = JSON.parse(localStorage.getItem('echoVerse_appOrder'));
            if (order && Array.isArray(order)) {
                // æ ¹æ®ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—åº”ç”¨
                this.appIcons.sort((a, b) => {
                    const indexA = order.indexOf(a.id);
                    const indexB = order.indexOf(b.id);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            }
        } catch (error) {
            console.log('åŠ è½½åº”ç”¨é¡ºåºå¤±è´¥');
        }
    }
    
    // æ‰“å¼€åº”ç”¨
    openApp(appId) {
        // æ‰¾åˆ°å¯¹åº”çš„åº”ç”¨
        const app = this.appIcons.find(a => a.id === appId);
        if (!app) return;
        
        // éšè—ä¸»å±å¹•
        this.container.classList.remove('active');
        this.container.classList.add('hidden');
        
        // æ˜¾ç¤ºç›®æ ‡åº”ç”¨
        const targetApp = document.getElementById(app.appId);
        if (targetApp) {
            targetApp.classList.remove('hidden');
            targetApp.classList.add('active');
        }
        
        // è§¦å‘åº”ç”¨æ‰“å¼€äº‹ä»¶
        const event = new CustomEvent('appOpen', {
            detail: { appId: appId }
        });
        document.dispatchEvent(event);
    }
    
    // æ›´æ¢å£çº¸
    async changeWallpaper(type, value) {
        this.wallpaper = { type, value };
        
        // æ›´æ–°æ ·å¼
        this.container.style.background = value;
        
        // ä¿å­˜è®¾ç½®
        await this.saveWallpaper();
    }
    
    // æ˜¾ç¤ºæ›´æ¢å£çº¸èœå•
    showWallpaperMenu() {
        const items = [
            {
                text: 'ä»ç›¸å†Œé€‰æ‹©',
                onClick: () => {
                    // æ‰“å¼€ç›¸å†Œé€‰æ‹©å£çº¸
                    this.openApp('gallery');
                    // è®¾ç½®ç›¸å†Œä¸ºå£çº¸é€‰æ‹©æ¨¡å¼
                    setTimeout(() => {
                        const galleryEvent = new CustomEvent('galleryMode', {
                            detail: { mode: 'wallpaper' }
                        });
                        document.dispatchEvent(galleryEvent);
                    }, 100);
                }
            },
            {
                text: 'æ¢å¤é»˜è®¤å£çº¸',
                onClick: () => {
                    this.changeWallpaper(
                        'gradient',
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                    );
                }
            }
        ];
        
        EchoVerseHelpers.createActionSheet({
            title: 'æ›´æ¢å£çº¸',
            items: items,
            onClose: () => console.log('å£çº¸èœå•å…³é—­')
        });
    }
    
    // è¿”å›åˆ°ä¸»å±å¹•
    returnToHome() {
        // éšè—æ‰€æœ‰åº”ç”¨
        const apps = document.querySelectorAll('.app-container');
        apps.forEach(app => {
            if (app.id !== 'launcher') {
                app.classList.remove('active');
                app.classList.add('hidden');
            }
        });
        
        // æ˜¾ç¤ºä¸»å±å¹•
        this.container.classList.remove('hidden');
        this.container.classList.add('active');
    }
}
// components/chat-app.js
class ChatApp {
    constructor() {
        this.container = null;
        this.currentView = 'list'; // list, chat, create, profile
        this.currentAI = null;
        this.messages = [];
        this.aiFriends = [];
        this.unreadCounts = {};
        
        // è¾“å…¥é™åˆ¶
        this.dailyLimits = null;
        this.maxMessagesPerDay = 300;
        this.maxMessageLength = 30;
        this.maxImagesPerDay = 3;
        this.maxGiftsPerDay = 1;
        this.maxGiftsAccumulated = 5;
        
        // ç»„ä»¶å¼•ç”¨
        this.chatList = null;
        this.chatDetail = null;
        this.createWizard = null;
        this.aiProfile = null;
        this.inputArea = null;
    }
    
    // åˆå§‹åŒ–èŠå¤©åº”ç”¨
    async init(containerId = 'chat-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // åŠ è½½æ•°æ®
        await this.loadData();
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
        
        // å¼€å§‹AIä¸»åŠ¨æ¶ˆæ¯æ£€æŸ¥
        this.startAIActiveMessageCheck();
    }
    
    // åŠ è½½æ•°æ®
    async loadData() {
        // åŠ è½½AIå¥½å‹
        this.aiFriends = await EchoVerseStorage.getAIFriends();
        
        // åŠ è½½æ¯æ—¥é™åˆ¶
        this.dailyLimits = await EchoVerseStorage.getDailyLimits();
        
        // è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°
        await this.calculateUnreadCounts();
        
        // æ£€æŸ¥æ¯æ—¥ä»»åŠ¡
        await this.checkDailyTasks();
    }
    
    // è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°
    async calculateUnreadCounts() {
        this.unreadCounts = {};
        
        for (const ai of this.aiFriends) {
            if (ai.state.isBlocked) continue;
            
            // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
            const messages = await EchoVerseStorage.getMessages(`conv_${ai.id}`, 1);
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                // å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯AIå‘é€çš„ï¼Œä¸”ç”¨æˆ·è¿˜æ²¡çœ‹è¿‡ï¼Œå°±è®¡ä¸ºæœªè¯»
                if (lastMessage.sender.startsWith('ai_') && lastMessage.status !== 'read') {
                    this.unreadCounts[ai.id] = (this.unreadCounts[ai.id] || 0) + 1;
                }
            }
        }
    }
    
    // æ£€æŸ¥æ¯æ—¥ä»»åŠ¡
    async checkDailyTasks() {
        const user = await EchoVerseStorage.getUser();
        const today = new Date().toDateString();
        
        // æ£€æŸ¥ç™»å½•ä»»åŠ¡
        if (!this.dailyLimits.tasks.login) {
            // å®Œæˆç™»å½•ä»»åŠ¡
            await this.completeTask('login');
        }
    }
    
    // å®Œæˆä»»åŠ¡
    async completeTask(taskType, aiId = null) {
        const updates = {};
        
        switch(taskType) {
            case 'login':
                updates.tasks = { login: true };
                await EchoVerseStorage.updateDailyLimits(updates);
                await this.addCoins(10, 'ç™»å½•ç­¾åˆ°');
                break;
                
            case 'chat_10':
                if (aiId && !this.dailyLimits.tasks.chat_10_completed.includes(aiId)) {
                    updates.tasks = { 
                        chat_10_completed: [...this.dailyLimits.tasks.chat_10_completed, aiId]
                    };
                    await EchoVerseStorage.updateDailyLimits(updates);
                    await this.addCoins(15, 'ç•…èŠä¸€åˆ»');
                }
                break;
                
            case 'send_gift':
                await this.addCoins(20, 'ç¤¼è½»æƒ…é‡');
                break;
        }
        
        EchoVerseHelpers.showToast(`å®Œæˆä»»åŠ¡ï¼š${taskType === 'login' ? 'ç™»å½•ç­¾åˆ°' : 
            taskType === 'chat_10' ? 'ç•…èŠä¸€åˆ»' : 'ç¤¼è½»æƒ…é‡'}`, 'success');
    }
    
    // æ·»åŠ çˆ±å¿ƒå¸
    async addCoins(amount, description) {
        const user = await EchoVerseStorage.getUser();
        const newBalance = user.wallet.balance + amount;
        
        await EchoVerseStorage.updateUser({
            wallet: {
                ...user.wallet,
                balance: newBalance,
                history: [
                    ...user.wallet.history,
                    {
                        id: `tx_${Date.now()}`,
                        type: 'task',
                        amount: amount,
                        description: description,
                        timestamp: Date.now()
                    }
                ]
            }
        });
        
        // æ›´æ–°é’±åŒ…æ˜¾ç¤º
        this.updateWalletDisplay();
    }
    
    // æ›´æ–°é’±åŒ…æ˜¾ç¤º
    updateWalletDisplay() {
        const walletElement = document.querySelector('.wallet-balance');
        if (walletElement) {
            EchoVerseStorage.getUser().then(user => {
                walletElement.textContent = EchoVerseHelpers.formatNumber(user.wallet.balance);
            });
        }
    }
    
    // æ¸²æŸ“èŠå¤©åº”ç”¨
    render() {
        this.container.innerHTML = `
            <div class="chat-container">
                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <div class="app-header">
                    <div class="header-left">
                        ${this.currentView === 'chat' ? `
                            <button class="btn-back">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="chat-title">
                                <div class="ai-avatar"></div>
                                <div class="ai-name"></div>
                            </div>
                        ` : `
                            <div class="app-title">èŠå¤©</div>
                        `}
                    </div>
                    <div class="header-right">
                        ${this.currentView === 'list' ? `
                            <button class="btn-menu" title="èœå•">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="chat-content">
                    ${this.currentView === 'list' ? this.renderChatList() :
                      this.currentView === 'chat' ? this.renderChatDetail() :
                      this.currentView === 'create' ? this.renderCreateWizard() :
                      this.currentView === 'profile' ? this.renderAIProfile() : ''}
                </div>
                
                <!-- åº•éƒ¨è¾“å…¥æ ï¼ˆä»…åœ¨èŠå¤©é¡µé¢æ˜¾ç¤ºï¼‰ -->
                ${this.currentView === 'chat' ? this.renderInputArea() : ''}
                
                <!-- åº•éƒ¨å¯¼èˆªæ  -->
                ${this.currentView === 'list' ? this.renderTabBar() : ''}
            </div>
        `;
        
        // ç¼“å­˜ç»„ä»¶å¼•ç”¨
        this.updateComponentRefs();
    }
    
    // æ¸²æŸ“èŠå¤©åˆ—è¡¨
    renderChatList() {
        let listHtml = '<div class="chat-list">';
        
        if (this.aiFriends.length === 0) {
            listHtml += `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">è¿˜æ²¡æœ‰AIå¥½å‹</div>
                    <div class="empty-description">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªAIå¥½å‹</div>
                    <button class="btn btn-primary" id="btn-create-first">
                        åˆ›å»ºAIå¥½å‹
                    </button>
                </div>
            `;
        } else {
            this.aiFriends.forEach(ai => {
                const unreadCount = this.unreadCounts[ai.id] || 0;
                const lastMessageTime = ai.state.lastMessageTime ? 
                    EchoVerseHelpers.formatTime(ai.state.lastMessageTime) : '';
                
                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ
                let lastMessage = '';
                if (ai.chatHistory && ai.chatHistory.length > 0) {
                    const lastMsgId = ai.chatHistory[ai.chatHistory.length - 1];
                    // è¿™é‡Œåº”è¯¥è·å–å®é™…æ¶ˆæ¯å†…å®¹ï¼Œç®€åŒ–å¤„ç†
                    lastMessage = 'ç‚¹å‡»å¼€å§‹å¯¹è¯';
                }
                
                listHtml += `
                    <div class="chat-list-item" data-ai-id="${ai.id}">
                        <div class="item-avatar">
                            ${this.renderAvatar(ai.profile.avatar)}
                            ${unreadCount > 0 ? `
                                <span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>
                            ` : ''}
                            ${ai.state.isBlocked ? `
                                <span class="blocked-badge">å·²æ‹‰é»‘</span>
                            ` : ''}
                        </div>
                        <div class="item-content">
                            <div class="item-header">
                                <div class="item-name">${ai.profile.name}</div>
                                <div class="item-time">${lastMessageTime}</div>
                            </div>
                            <div class="item-preview">
                                ${ai.state.isConfigured ? lastMessage : 'æœªé…ç½®ï¼Œç‚¹å‡»é…ç½®'}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        listHtml += '</div>';
        return listHtml;
    }
    
    // æ¸²æŸ“èŠå¤©è¯¦æƒ…
    renderChatDetail() {
        if (!this.currentAI) return '<div class="chat-detail">è¯·é€‰æ‹©ä¸€ä¸ªAIå¥½å‹</div>';
        
        return `
            <div class="chat-detail">
                <div class="message-list" id="message-list">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“è¾“å…¥åŒºåŸŸ
    renderInputArea() {
        if (!this.currentAI) return '';
        
        const messagesSent = this.dailyLimits.limits.messages_sent || 0;
        const imagesSent = this.dailyLimits.limits.images_sent || 0;
        const giftsAvailable = Math.min(
            this.dailyLimits.limits.gifts_accumulated || 0,
            this.maxGiftsAccumulated
        );
        
        return `
            <div class="input-area">
                <div class="input-counter">
                    ä»Šæ—¥æ¶ˆæ¯: ${messagesSent}/${this.maxMessagesPerDay}
                </div>
                <div class="input-container">
                    <input type="text" 
                           class="message-input" 
                           placeholder="è¯´ç‚¹ä»€ä¹ˆ... (æœ€å¤š30å­—)"
                           maxlength="30">
                    <button class="btn-send" title="å‘é€">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="btn-attach" title="é™„ä»¶">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="quick-actions">
                    <button class="btn-quick btn-image" 
                            ${imagesSent >= this.maxImagesPerDay ? 'disabled' : ''}
                            title="å‘é€å›¾ç‰‡ (${imagesSent}/${this.maxImagesPerDay})">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="btn-quick btn-gift"
                            ${giftsAvailable <= 0 ? 'disabled' : ''}
                            title="èµ é€ç¤¼ç‰© (${giftsAvailable}æ¬¡)">
                        <i class="fas fa-gift"></i>
                    </button>
                    <button class="btn-quick btn-emoji" title="è¡¨æƒ…">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“åº•éƒ¨å¯¼èˆªæ 
    renderTabBar() {
        return `
            <div class="tab-bar">
                <div class="tab-item active" data-tab="chat">
                    <i class="fas fa-comment"></i>
                    <span>èŠå¤©</span>
                </div>
                <div class="tab-item" data-tab="discover">
                    <i class="fas fa-compass"></i>
                    <span>å‘ç°</span>
                </div>
                <div class="tab-item" data-tab="me">
                    <i class="fas fa-user"></i>
                    <span>æˆ‘</span>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“AIåˆ›å»ºå‘å¯¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
    renderCreateWizard() {
        return `
            <div class="create-wizard">
                <div class="wizard-header">
                    <button class="btn-back">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="wizard-title">åˆ›å»ºAIå¥½å‹</div>
                </div>
                
                <div class="wizard-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title">åŸºæœ¬ä¿¡æ¯</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title">è§’è‰²è®¾å®š</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title">APIé…ç½®</div>
                    </div>
                </div>
                
                <div class="wizard-content">
                    <div class="step-content step-1">
                        <div class="form-group">
                            <label class="input-label">AIåç§°</label>
                            <input type="text" class="input-field" id="ai-name" 
                                   placeholder="ä¸ºä½ çš„AIå¥½å‹èµ·ä¸ªåå­—" maxlength="20">
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">å¤´åƒ</label>
                            <div class="avatar-selector">
                                <div class="avatar-preview" id="avatar-preview"></div>
                                <button class="btn btn-secondary" id="btn-change-avatar">
                                    æ›´æ¢å¤´åƒ
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">æ€§åˆ«</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="male" checked>
                                    <span>ç”·</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="female">
                                    <span>å¥³</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="other">
                                    <span>å…¶ä»–</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="unspecified">
                                    <span>ä¿å¯†</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-next" data-next="2">
                            ä¸‹ä¸€æ­¥
                        </button>
                    </div>
                    
                    <div class="step-content step-2 hidden">
                        <div class="form-group">
                            <label class="input-label">è§’è‰²è®¾å®š</label>
                            <textarea class="input-field" id="ai-system-prompt" 
                                      rows="6" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªAIçš„è§’è‰²ã€æ€§æ ¼ã€èƒŒæ™¯ç­‰..."
                                      maxlength="2000"></textarea>
                            <div class="char-counter">
                                <span id="char-count">0</span>/2000
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">æ€§æ ¼ç‰¹è´¨</label>
                            <div class="slider-group">
                                <label>æ¸©æš–ç¨‹åº¦</label>
                                <input type="range" min="0" max="10" value="8" class="slider" 
                                       data-trait="warmth">
                            </div>
                            <div class="slider-group">
                                <label>å¹½é»˜æ„Ÿ</label>
                                <input type="range" min="0" max="10" value="6" class="slider"
                                       data-trait="humor">
                            </div>
                            <div class="slider-group">
                                <label>å¥½å¥‡å¿ƒ</label>
                                <input type="range" min="0" max="10" value="9" class="slider"
                                       data-trait="curiosity">
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-secondary btn-prev" data-prev="1">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button class="btn btn-primary btn-next" data-next="3">
                                ä¸‹ä¸€æ­¥
                            </button>
                        </div>
                    </div>
                    
                    <div class="step-content step-3 hidden">
                        <div class="form-group">
                            <label class="input-label">APIæä¾›å•†</label>
                            <select class="input-field" id="api-provider">
                                <option value="openai">OpenAI GPT</option>
                                <option value="claude">Claude</option>
                                <option value="custom">è‡ªå®šä¹‰API</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">APIå¯†é’¥</label>
                            <input type="password" class="input-field" id="api-key" 
                                   placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">æ¨¡å‹</label>
                            <input type="text" class="input-field" id="api-model" 
                                   value="gpt-3.5-turbo" placeholder="æ¨¡å‹åç§°">
                        </div>
                        
                        <div class="form-group">
                            <label class="input-label">æ¸©åº¦ (Temperature)</label>
                            <input type="range" min="0" max="20" value="8" class="slider" 
                                   id="temperature">
                            <div class="slider-value">0.8</div>
                        </div>
                        
                        <button class="btn btn-secondary" id="btn-test-api">
                            æµ‹è¯•è¿æ¥
                        </button>
                        
                        <div class="button-group">
                            <button class="btn btn-secondary btn-prev" data-prev="2">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button class="btn btn-primary" id="btn-create-ai">
                                å®Œæˆåˆ›å»º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“AIèµ„æ–™å¡
    renderAIProfile() {
        if (!this.currentAI) return '';
        
        const ai = this.currentAI;
        const avatarHtml = this.renderAvatar(ai.profile.avatar, 'large');
        
        return `
            <div class="ai-profile">
                <div class="profile-header">
                    <div class="profile-banner" style="background: ${ai.profile.banner.gradient ? 
                        `linear-gradient(135deg, ${ai.profile.banner.gradient[0]}, ${ai.profile.banner.gradient[1]})` : 
                        ai.profile.banner.color || '#667eea'}">
                    </div>
                    <div class="profile-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="profile-name">${ai.profile.name}</div>
                    <div class="profile-signature">${ai.profile.basicInfo.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™'}</div>
                </div>
                
                <div class="profile-content">
                    <div class="profile-section">
                        <h3 class="section-title">åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">æ€§åˆ«</div>
                                <div class="info-value">${ai.profile.basicInfo.gender === 'male' ? 'ç”·' : 
                                                        ai.profile.basicInfo.gender === 'female' ? 'å¥³' : 
                                                        ai.profile.basicInfo.gender === 'other' ? 'å…¶ä»–' : 'ä¿å¯†'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å¹´é¾„</div>
                                <div class="info-value">${ai.profile.basicInfo.age || 'æœªçŸ¥'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">èŒä¸š</div>
                                <div class="info-value">${ai.profile.basicInfo.occupation || 'æœªçŸ¥'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3 class="section-title">æ€§æ ¼æ ‡ç­¾</h3>
                        <div class="tag-list">
                            ${ai.profile.basicInfo.personalityTags.map(tag => `
                                <span class="tag">${tag}</span>
                            `).join('')}
                            ${ai.profile.basicInfo.customTags.map(tag => `
                                <span class="tag custom">${tag}</span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3 class="section-title">
                            è§’è‰²è®¾å®š
                            <button class="btn-edit" data-edit="systemPrompt">
                                <i class="fas fa-edit"></i>
                            </button>
                        </h3>
                        <div class="system-prompt">
                            ${ai.character.systemPrompt || 'æœªè®¾ç½®è§’è‰²è®¾å®š'}
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3 class="section-title">
                            APIé…ç½®
                            <button class="btn-edit" data-edit="apiConfig">
                                <i class="fas fa-edit"></i>
                            </button>
                        </h3>
                        <div class="api-info">
                            <div class="api-provider">${ai.apiConfig.provider}</div>
                            <div class="api-model">${ai.apiConfig.model}</div>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button class="btn btn-primary" id="btn-send-message">
                            å‘æ¶ˆæ¯
                        </button>
                        <button class="btn btn-secondary" id="btn-block-ai">
                            ${ai.state.isBlocked ? 'å–æ¶ˆæ‹‰é»‘' : 'æ‹‰é»‘'}
                        </button>
                        <button class="btn btn-danger" id="btn-delete-ai">
                            åˆ é™¤å¥½å‹
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“å¤´åƒ
    renderAvatar(avatarData, size = 'normal') {
        const sizes = {
            small: '32px',
            normal: '48px',
            large: '80px'
        };
        
        const sizePx = sizes[size] || sizes.normal;
        
        if (avatarData.type === 'emoji') {
            return `
                <div class="avatar-emoji" style="
                    width: ${sizePx};
                    height: ${sizePx};
                    background-color: ${avatarData.backgroundColor};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: ${size === 'large' ? '24px' : '16px'};
                    color: white;
                    font-weight: bold;
                ">
                    ${avatarData.content}
                </div>
            `;
        } else if (avatarData.type === 'image') {
            return `
                <img src="${avatarData.content}" 
                     class="avatar-image" 
                     style="width: ${sizePx}; height: ${sizePx}; border-radius: 50%;">
            `;
        } else {
            // é»˜è®¤å¤´åƒ
            const randomColor = EchoVerseHelpers.generateRandomColor();
            const letter = avatarData.content ? avatarData.content.charAt(0).toUpperCase() : 'A';
            
            return `
                <div class="avatar-default" style="
                    width: ${sizePx};
                    height: ${sizePx};
                    background-color: ${randomColor};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: ${size === 'large' ? '24px' : '16px'};
                    color: white;
                    font-weight: bold;
                ">
                    ${letter}
                </div>
            `;
        }
    }
    
    // æ›´æ–°ç»„ä»¶å¼•ç”¨
    updateComponentRefs() {
        if (this.currentView === 'list') {
            this.chatList = this.container.querySelector('.chat-list');
        } else if (this.currentView === 'chat') {
            this.chatDetail = this.container.querySelector('.chat-detail');
            this.messageList = this.container.querySelector('#message-list');
            this.inputArea = this.container.querySelector('.input-area');
            
            // åŠ è½½æ¶ˆæ¯
            if (this.currentAI) {
                this.loadMessages();
            }
        } else if (this.currentView === 'create') {
            this.createWizard = this.container.querySelector('.create-wizard');
        } else if (this.currentView === 'profile') {
            this.aiProfile = this.container.querySelector('.ai-profile');
        }
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // å…¨å±€åº”ç”¨äº‹ä»¶
        document.addEventListener('appOpen', (e) => {
            if (e.detail.appId === 'chat') {
                this.refreshData();
            }
        });
        
        // èŠå¤©åˆ—è¡¨é¡¹ç‚¹å‡»
        if (this.chatList) {
            this.chatList.addEventListener('click', (e) => {
                const listItem = e.target.closest('.chat-list-item');
                if (listItem) {
                    const aiId = listItem.dataset.aiId;
                    this.openChat(aiId);
                }
            });
        }
        
        // è¿”å›æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-back')) {
                this.goBack();
            }
        });
        
        // èœå•æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-menu')) {
                this.showMainMenu();
            }
        });
        
        // å‘é€æ¶ˆæ¯
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-send')) {
                this.sendMessage();
            }
        });
        
        // è¾“å…¥æ¡†å›è½¦å‘é€
        this.container.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('message-input') && e.key === 'Enter') {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // é™„ä»¶æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-attach')) {
                this.showAttachmentMenu();
            }
        });
        
        // å›¾ç‰‡æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-image')) {
                this.sendImage();
            }
        });
        
        // ç¤¼ç‰©æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-gift')) {
                this.sendGift();
            }
        });
        
        // AIå¤´åƒç‚¹å‡»ï¼ˆæ‰“å¼€èµ„æ–™å¡ï¼‰
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.ai-avatar') || e.target.closest('.ai-name')) {
                if (this.currentAI) {
                    this.showAIProfile();
                }
            }
        });
        
        // åˆ›å»ºAIæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.id === 'btn-create-first' || e.target.closest('#btn-create-first')) {
                this.showCreateWizard();
            }
        });
        
        // å‘å¯¼ä¸‹ä¸€æ­¥/ä¸Šä¸€æ­¥æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-next')) {
                const nextStep = e.target.dataset.next;
                this.goToStep(nextStep);
            } else if (e.target.classList.contains('btn-prev')) {
                const prevStep = e.target.dataset.prev;
                this.goToStep(prevStep);
            }
        });
        
        // åˆ›å»ºAIå®ŒæˆæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.id === 'btn-create-ai' || e.target.closest('#btn-create-ai')) {
                this.createAI();
            }
        });
        
        // æµ‹è¯•APIæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.id === 'btn-test-api' || e.target.closest('#btn-test-api')) {
                this.testAPI();
            }
        });
        
        // èµ„æ–™å¡æ“ä½œæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.id === 'btn-send-message' || e.target.closest('#btn-send-message')) {
                this.goBackToChat();
            } else if (e.target.id === 'btn-block-ai' || e.target.closest('#btn-block-ai')) {
                this.toggleBlockAI();
            } else if (e.target.id === 'btn-delete-ai' || e.target.closest('#btn-delete-ai')) {
                this.deleteAI();
            } else if (e.target.classList.contains('btn-edit')) {
                const editType = e.target.dataset.edit;
                this.editAIInfo(editType);
            }
        });
    }
    
    // æ‰“å¼€èŠå¤©
    async openChat(aiId) {
        const ai = this.aiFriends.find(a => a.id === aiId);
        if (!ai) return;
        
        this.currentAI = ai;
        this.currentView = 'chat';
        this.messages = [];
        
        // æ›´æ–°è§†å›¾
        this.render();
        
        // åŠ è½½æ¶ˆæ¯
        await this.loadMessages();
        
        // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
        await this.markMessagesAsRead();
    }
    
    // åŠ è½½æ¶ˆæ¯
    async loadMessages() {
        if (!this.currentAI || !this.messageList) return;
        
        const messages = await EchoVerseStorage.getMessages(`conv_${this.currentAI.id}`);
        this.messages = messages;
        
        // æ¸²æŸ“æ¶ˆæ¯
        this.renderMessages();
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        this.scrollToBottom();
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    renderMessages() {
        if (!this.messageList) return;
        
        this.messageList.innerHTML = '';
        
        this.messages.forEach(message => {
            const isAI = message.sender.startsWith('ai_');
            const messageElement = this.createMessageElement(message, isAI);
            this.messageList.appendChild(messageElement);
        });
        
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤º
        if (this.messages.length === 0) {
            this.messageList.innerHTML = `
                <div class="empty-messages">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
                    <div class="empty-description">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</div>
                </div>
            `;
        }
    }
    
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    createMessageElement(message, isAI) {
        const time = EchoVerseHelpers.formatMessageTime(message.timestamp);
        
        let content = '';
        if (message.type === 'text') {
            content = message.content;
        } else if (message.type === 'image') {
            content = `<img src="${message.media.data}" class="message-image">`;
        } else if (message.type === 'gift') {
            content = `[èµ é€äº†${message.media.itemName}]`;
        }
        
        return `
            <div class="message ${isAI ? 'message-left' : 'message-right'}">
                <div class="message-bubble ${isAI ? 'bubble-left' : 'bubble-right'}">
                    ${content}
                </div>
                <div class="message-time">${time}</div>
            </div>
        `;
    }
    
    // å‘é€æ¶ˆæ¯
    async sendMessage() {
        const input = this.container.querySelector('.message-input');
        if (!input) return;
        
        const content = input.value.trim();
        if (!content) return;
        
        // æ£€æŸ¥æ¶ˆæ¯é•¿åº¦
        if (EchoVerseHelpers.getTextLength(content) > this.maxMessageLength) {
            EchoVerseHelpers.showToast(`æ¶ˆæ¯ä¸èƒ½è¶…è¿‡${this.maxMessageLength}å­—`, 'error');
            input.classList.add('error');
            setTimeout(() => input.classList.remove('error'), 1000);
            return;
        }
        
        // æ£€æŸ¥æ¯æ—¥é™åˆ¶
        if (this.dailyLimits.limits.messages_sent >= this.maxMessagesPerDay) {
            EchoVerseHelpers.showToast('ä»Šæ—¥æ¶ˆæ¯é¢åº¦å·²ç”¨å°½', 'error');
            return;
        }
        
        // å‘é€æ¶ˆæ¯
        await this.addMessage('user', content, 'text');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        
        // æ›´æ–°æ¯æ—¥é™åˆ¶
        await this.updateDailyLimit('messages_sent');
        
        // AIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
        setTimeout(() => {
            this.sendAIResponse();
        }, 1000);
    }
    
    // å‘é€AIå›å¤
    async sendAIResponse() {
        if (!this.currentAI) return;
        
        // æ¨¡æ‹ŸAIå›å¤
        const responses = [
            "æ”¶åˆ°ä½ çš„æ¶ˆæ¯äº†ï¼",
            "æˆ‘åœ¨å‘¢ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
            "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼Œè®©æˆ‘æƒ³æƒ³...",
            "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ",
            "æˆ‘ä¸€ç›´åœ¨å­¦ä¹ æ–°çš„ä¸œè¥¿å‘¢ï¼"
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        await this.addMessage(`ai_${this.currentAI.id}`, randomResponse, 'text');
        
        // æ£€æŸ¥æ˜¯å¦å®ŒæˆèŠå¤©ä»»åŠ¡
        const messageCount = await EchoVerseStorage.getMessageCount(this.currentAI.id);
        if (messageCount >= 10 && !this.dailyLimits.tasks.chat_10_completed.includes(this.currentAI.id)) {
            await this.completeTask('chat_10', this.currentAI.id);
        }
    }
    
    // æ·»åŠ æ¶ˆæ¯
    async addMessage(sender, content, type, media = null) {
        if (!this.currentAI) return;
        
        const message = {
            conversationId: `conv_${this.currentAI.id}`,
            sender: sender,
            content: content,
            type: type,
            media: media,
            status: 'sent'
        };
        
        const savedMessage = await EchoVerseStorage.addMessage(message);
        this.messages.push(savedMessage);
        
        // æ›´æ–°æ˜¾ç¤º
        this.renderMessages();
        this.scrollToBottom();
        
        return savedMessage;
    }
    
    // å‘é€å›¾ç‰‡
    async sendImage() {
        // æ£€æŸ¥æ¯æ—¥é™åˆ¶
        if (this.dailyLimits.limits.images_sent >= this.maxImagesPerDay) {
            EchoVerseHelpers.showToast('ä»Šæ—¥å›¾ç‰‡å‘é€é¢åº¦å·²ç”¨å°½', 'error');
            return;
        }
        
        // åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // å‹ç¼©å›¾ç‰‡
                const compressedImage = await EchoVerseHelpers.compressImage(file);
                const thumbnail = await EchoVerseHelpers.createThumbnail(compressedImage);
                
                // ä¿å­˜åˆ°ç›¸å†Œ
                await EchoVerseStorage.addPhoto({
                    type: 'photo',
                    data: compressedImage,
                    thumbnail: thumbnail,
                    source: 'chat'
                });
                
                // å‘é€æ¶ˆæ¯
                await this.addMessage('user', '[å›¾ç‰‡]', 'image', {
                    type: 'image',
                    data: compressedImage,
                    thumbnail: thumbnail
                });
                
                // æ›´æ–°æ¯æ—¥é™åˆ¶
                await this.updateDailyLimit('images_sent');
                
                // AIå›å¤
                setTimeout(() => {
                    this.sendAIResponse();
                }, 1000);
                
            } catch (error) {
                EchoVerseHelpers.showToast('å‘é€å›¾ç‰‡å¤±è´¥', 'error');
                console.error(error);
            }
        };
        
        input.click();
    }
    
    // å‘é€ç¤¼ç‰©
    async sendGift() {
        // æ£€æŸ¥æ˜¯å¦æœ‰å¯èµ é€çš„ç¤¼ç‰©
        const giftsAvailable = Math.min(
            this.dailyLimits.limits.gifts_accumulated || 0,
            this.maxGiftsAccumulated
        );
        
        if (giftsAvailable <= 0) {
            EchoVerseHelpers.showToast('ä»Šæ—¥æ²¡æœ‰å¯èµ é€çš„ç¤¼ç‰©æ¬¡æ•°', 'error');
            return;
        }
        
        // è·å–èƒŒåŒ…ç‰©å“
        const inventory = await EchoVerseStorage.getAll('inventory');
        const giftableItems = inventory.filter(item => item.giftable && item.owned > 0);
        
        if (giftableItems.length === 0) {
            EchoVerseHelpers.showToast('èƒŒåŒ…ä¸­æ²¡æœ‰å¯èµ é€çš„ç‰©å“', 'error');
            return;
        }
        
        // æ˜¾ç¤ºç¤¼ç‰©é€‰æ‹©èœå•
        const items = giftableItems.map(item => ({
            text: `${item.name} (å‰©ä½™: ${item.owned})`,
            onClick: () => this.confirmSendGift(item)
        }));
        
        EchoVerseHelpers.createActionSheet({
            title: 'é€‰æ‹©è¦èµ é€çš„ç¤¼ç‰©',
            items: items
        });
    }
    
    // ç¡®è®¤èµ é€ç¤¼ç‰©
    async confirmSendGift(item) {
        const confirm = await EchoVerseHelpers.createModal({
            title: 'èµ é€ç¤¼ç‰©',
            content: `ç¡®å®šè¦èµ é€ã€${item.name}ã€‘ç»™${this.currentAI.profile.name}å—ï¼Ÿ`,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç¡®è®¤èµ é€',
                    class: 'btn-primary',
                    onClick: () => this.executeSendGift(item)
                }
            ]
        });
    }
    
    // æ‰§è¡Œèµ é€ç¤¼ç‰©
    async executeSendGift(item) {
        // å‡å°‘ç‰©å“æ•°é‡
        const updatedItem = { ...item, owned: item.owned - 1 };
        if (updatedItem.owned <= 0) {
            await EchoVerseStorage.delete('inventory', item.itemId);
        } else {
            await EchoVerseStorage.update('inventory', updatedItem);
        }
        
        // å‘é€ç¤¼ç‰©æ¶ˆæ¯
        await this.addMessage('user', `[èµ é€äº†${item.name}]`, 'gift', {
            type: 'gift_item',
            itemId: item.itemId,
            itemName: item.name
        });
        
        // æ›´æ–°æ¯æ—¥é™åˆ¶
        await this.updateDailyLimit('gifts_sent');
        
        // å®Œæˆä»»åŠ¡
        await this.completeTask('send_gift');
        
        EchoVerseHelpers.showToast('ç¤¼ç‰©èµ é€æˆåŠŸï¼', 'success');
        
        // AIå›å¤
        setTimeout(() => {
            this.addMessage(`ai_${this.currentAI.id}`, `è°¢è°¢ä½ çš„${item.name}ï¼æˆ‘å¾ˆå–œæ¬¢ï¼`, 'text');
        }, 1000);
    }
    
    // æ›´æ–°æ¯æ—¥é™åˆ¶
    async updateDailyLimit(limitType, value = 1) {
        const newValue = (this.dailyLimits.limits[limitType] || 0) + value;
        
        await EchoVerseStorage.updateDailyLimits({
            limits: {
                [limitType]: newValue
            }
        });
        
        // é‡æ–°åŠ è½½é™åˆ¶
        this.dailyLimits = await EchoVerseStorage.getDailyLimits();
        
        // æ›´æ–°UI
        this.updateLimitDisplay();
    }
    
    // æ›´æ–°é™åˆ¶æ˜¾ç¤º
    updateLimitDisplay() {
        // æ›´æ–°è®¡æ•°å™¨æ˜¾ç¤º
        const counter = this.container.querySelector('.input-counter');
        if (counter) {
            counter.textContent = `ä»Šæ—¥æ¶ˆæ¯: ${this.dailyLimits.limits.messages_sent}/${this.maxMessagesPerDay}`;
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const imageBtn = this.container.querySelector('.btn-image');
        if (imageBtn) {
            const imagesSent = this.dailyLimits.limits.images_sent || 0;
            imageBtn.disabled = imagesSent >= this.maxImagesPerDay;
            imageBtn.title = `å‘é€å›¾ç‰‡ (${imagesSent}/${this.maxImagesPerDay})`;
        }
        
        const giftBtn = this.container.querySelector('.btn-gift');
        if (giftBtn) {
            const giftsAvailable = Math.min(
                this.dailyLimits.limits.gifts_accumulated || 0,
                this.maxGiftsAccumulated
            );
            giftBtn.disabled = giftsAvailable <= 0;
            giftBtn.title = `èµ é€ç¤¼ç‰© (${giftsAvailable}æ¬¡)`;
        }
    }
    
    // æ˜¾ç¤ºé™„ä»¶èœå•
    showAttachmentMenu() {
        const items = [
            {
                text: 'å‘é€å›¾ç‰‡',
                onClick: () => this.sendImage()
            },
            {
                text: 'èµ é€ç¤¼ç‰©',
                onClick: () => this.sendGift()
            },
            {
                text: 'æ‹æ‘„ç…§ç‰‡',
                onClick: () => {
                    // æ‰“å¼€ç›¸æœºåº”ç”¨
                    const event = new CustomEvent('appOpen', {
                        detail: { appId: 'camera' }
                    });
                    document.dispatchEvent(event);
                }
            }
        ];
        
        EchoVerseHelpers.createActionSheet({
            title: 'æ›´å¤šæ“ä½œ',
            items: items
        });
    }
    
    // æ˜¾ç¤ºä¸»èœå•
    showMainMenu() {
        const items = [
            {
                text: 'åˆ›å»ºæ–°AI',
                onClick: () => this.showCreateWizard()
            },
            {
                text: 'APIé…ç½®ä¸­å¿ƒ',
                onClick: () => this.showAPIConfigCenter()
            },
            {
                text: 'ç®¡ç†AIå¥½å‹',
                onClick: () => this.showAIManagement()
            }
        ];
        
        EchoVerseHelpers.createActionSheet({
            title: 'èŠå¤©è®¾ç½®',
            items: items
        });
    }
    
    // æ˜¾ç¤ºåˆ›å»ºå‘å¯¼
    showCreateWizard() {
        this.currentView = 'create';
        this.currentAI = null;
        this.render();
    }
    
    // æ˜¾ç¤ºAIèµ„æ–™å¡
    showAIProfile() {
        this.currentView = 'profile';
        this.render();
    }
    
    // è¿”å›ä¸Šä¸€é¡µ
    goBack() {
        if (this.currentView === 'chat' || this.currentView === 'profile') {
            this.currentView = 'list';
            this.currentAI = null;
            this.render();
        } else if (this.currentView === 'create') {
            this.currentView = 'list';
            this.render();
        }
    }
    
    // è¿”å›èŠå¤©
    goBackToChat() {
        this.currentView = 'chat';
        this.render();
    }
    
    // å‘å¯¼æ­¥éª¤åˆ‡æ¢
    goToStep(step) {
        const steps = this.container.querySelectorAll('.step');
        const stepContents = this.container.querySelectorAll('.step-content');
        
        steps.forEach(s => s.classList.remove('active'));
        stepContents.forEach(c => c.classList.add('hidden'));
        
        const targetStep = this.container.querySelector(`.step[data-step="${step}"]`);
        const targetContent = this.container.querySelector(`.step-${step}`);
        
        if (targetStep && targetContent) {
            targetStep.classList.add('active');
            targetContent.classList.remove('hidden');
        }
    }
    
    // åˆ›å»ºAI
    async createAI() {
        // æ”¶é›†è¡¨å•æ•°æ®
        const name = this.container.querySelector('#ai-name').value.trim();
        const systemPrompt = this.container.querySelector('#ai-system-prompt').value.trim();
        const apiKey = this.container.querySelector('#api-key').value.trim();
        
        if (!name) {
            EchoVerseHelpers.showToast('è¯·å¡«å†™AIåç§°', 'error');
            return;
        }
        
        if (!systemPrompt) {
            EchoVerseHelpers.showToast('è¯·å¡«å†™è§’è‰²è®¾å®š', 'error');
            return;
        }
        
        if (!apiKey) {
            EchoVerseHelpers.showToast('è¯·å¡«å†™APIå¯†é’¥', 'error');
            return;
        }
        
        // æ”¶é›†å…¶ä»–æ•°æ®
        const gender = this.container.querySelector('input[name="gender"]:checked').value;
        const provider = this.container.querySelector('#api-provider').value;
        const model = this.container.querySelector('#api-model').value;
        
        // åˆ›å»ºAI
        const aiData = {
            name: name,
            gender: gender,
            systemPrompt: systemPrompt,
            apiConfig: {
                provider: provider,
                apiKey: EchoVerseStorage.encrypt(apiKey),
                model: model,
                parameters: {
                    temperature: 0.8,
                    maxTokens: 2000
                }
            }
        };
        
        try {
            const newAI = await EchoVerseStorage.createAIFriend(aiData);
            
            EchoVerseHelpers.showToast('AIå¥½å‹åˆ›å»ºæˆåŠŸï¼', 'success');
            
            // è¿”å›åˆ—è¡¨å¹¶åˆ·æ–°
            this.currentView = 'list';
            await this.refreshData();
            this.render();
            
        } catch (error) {
            EchoVerseHelpers.showToast('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
        }
    }
    
    // æµ‹è¯•APIè¿æ¥
    async testAPI() {
        const apiKey = this.container.querySelector('#api-key').value.trim();
        
        if (!apiKey) {
            EchoVerseHelpers.showToast('è¯·å¡«å†™APIå¯†é’¥', 'error');
            return;
        }
        
        EchoVerseHelpers.showToast('æµ‹è¯•è¿æ¥ä¸­...', 'info');
        
        // æ¨¡æ‹ŸAPIæµ‹è¯•
        setTimeout(() => {
            EchoVerseHelpers.showToast('è¿æ¥æˆåŠŸï¼', 'success');
        }, 1500);
    }
    
    // åˆ‡æ¢æ‹‰é»‘çŠ¶æ€
    async toggleBlockAI() {
        if (!this.currentAI) return;
        
        const newBlockedState = !this.currentAI.state.isBlocked;
        const confirmText = newBlockedState ? 
            `ç¡®å®šè¦æ‹‰é»‘${this.currentAI.profile.name}å—ï¼Ÿæ‹‰é»‘åå°†ä¸å†æ”¶åˆ°æ–°æ¶ˆæ¯æé†’ã€‚` :
            `ç¡®å®šè¦å–æ¶ˆæ‹‰é»‘${this.currentAI.profile.name}å—ï¼Ÿ`;
        
        const confirmed = await EchoVerseHelpers.createModal({
            title: newBlockedState ? 'ç¡®è®¤æ‹‰é»‘' : 'ç¡®è®¤å–æ¶ˆæ‹‰é»‘',
            content: confirmText,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: newBlockedState ? 'ç¡®è®¤æ‹‰é»‘' : 'ç¡®è®¤å–æ¶ˆ',
                    class: newBlockedState ? 'btn-danger' : 'btn-primary',
                    onClick: async () => {
                        await EchoVerseStorage.updateAIFriend(this.currentAI.id, {
                            'state.isBlocked': newBlockedState
                        });
                        
                        EchoVerseHelpers.showToast(
                            newBlockedState ? 'å·²æ‹‰é»‘' : 'å·²å–æ¶ˆæ‹‰é»‘',
                            'success'
                        );
                        
                        // åˆ·æ–°æ•°æ®
                        await this.refreshData();
                        
                        // å¦‚æœæ˜¯æ‹‰é»‘ï¼Œè¿”å›åˆ—è¡¨
                        if (newBlockedState) {
                            this.goBack();
                        } else {
                            // åˆ·æ–°èµ„æ–™å¡
                            this.currentAI = await EchoVerseStorage.getAIFriend(this.currentAI.id);
                            this.render();
                        }
                    }
                }
            ]
        });
    }
    
    // åˆ é™¤AI
    async deleteAI() {
        if (!this.currentAI) return;
        
        const confirmed = await EchoVerseHelpers.createModal({
            title: 'åˆ é™¤å¥½å‹',
            content: `
                <p>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ä¸${this.currentAI.profile.name}çš„æ‰€æœ‰èŠå¤©è®°å½•ã€‚</p>
                <p style="color: var(--danger-red); font-weight: bold;">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç¡®è®¤åˆ é™¤',
                    class: 'btn-danger',
                    onClick: async () => {
                        await EchoVerseStorage.deleteAIFriend(this.currentAI.id);
                        
                        EchoVerseHelpers.showToast('å¥½å‹åˆ é™¤æˆåŠŸ', 'success');
                        
                        // è¿”å›åˆ—è¡¨å¹¶åˆ·æ–°
                        this.currentView = 'list';
                        this.currentAI = null;
                        await this.refreshData();
                        this.render();
                    }
                }
            ]
        });
    }
    
    // ç¼–è¾‘AIä¿¡æ¯
    editAIInfo(editType) {
        if (!this.currentAI) return;
        
        if (editType === 'systemPrompt') {
            this.editSystemPrompt();
        } else if (editType === 'apiConfig') {
            this.editAPIConfig();
        }
    }
    
    // ç¼–è¾‘è§’è‰²è®¾å®š
    async editSystemPrompt() {
        const currentPrompt = this.currentAI.character.systemPrompt;
        
        const modalId = EchoVerseHelpers.createModal({
            title: 'ç¼–è¾‘è§’è‰²è®¾å®š',
            content: `
                <textarea id="edit-system-prompt" class="input-field" rows="8">${currentPrompt}</textarea>
                <div class="char-counter">
                    <span id="edit-char-count">${currentPrompt.length}</span>/2000
                </div>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ä¿å­˜',
                    class: 'btn-primary',
                    onClick: async () => {
                        const textarea = document.getElementById('edit-system-prompt');
                        const newPrompt = textarea.value.trim();
                        
                        if (!newPrompt) {
                            EchoVerseHelpers.showToast('è§’è‰²è®¾å®šä¸èƒ½ä¸ºç©º', 'error');
                            return;
                        }
                        
                        await EchoVerseStorage.updateAIFriend(this.currentAI.id, {
                            'character.systemPrompt': newPrompt
                        });
                        
                        EchoVerseHelpers.showToast('è§’è‰²è®¾å®šå·²æ›´æ–°', 'success');
                        
                        // åˆ·æ–°å½“å‰AIæ•°æ®
                        this.currentAI = await EchoVerseStorage.getAIFriend(this.currentAI.id);
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        EchoVerseHelpers.closeModal(modalId);
                        
                        // åˆ·æ–°èµ„æ–™å¡
                        this.render();
                    }
                }
            ]
        });
        
        // ç»‘å®šå­—ç¬¦è®¡æ•°
        const textarea = document.getElementById('edit-system-prompt');
        const charCount = document.getElementById('edit-char-count');
        
        textarea.addEventListener('input', () => {
            charCount.textContent = textarea.value.length;
        });
    }
    
    // ç¼–è¾‘APIé…ç½®
    async editAPIConfig() {
        const ai = this.currentAI;
        
        const modalId = EchoVerseHelpers.createModal({
            title: 'ç¼–è¾‘APIé…ç½®',
            content: `
                <div class="form-group">
                    <label class="input-label">APIæä¾›å•†</label>
                    <select class="input-field" id="edit-api-provider">
                        <option value="openai" ${ai.apiConfig.provider === 'openai' ? 'selected' : ''}>OpenAI GPT</option>
                        <option value="claude" ${ai.apiConfig.provider === 'claude' ? 'selected' : ''}>Claude</option>
                        <option value="custom" ${ai.apiConfig.provider === 'custom' ? 'selected' : ''}>è‡ªå®šä¹‰API</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="input-label">APIå¯†é’¥</label>
                    <input type="password" class="input-field" id="edit-api-key" 
                           value="${EchoVerseStorage.decrypt(ai.apiConfig.apiKey)}"
                           placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                </div>
                
                <div class="form-group">
                    <label class="input-label">æ¨¡å‹</label>
                    <input type="text" class="input-field" id="edit-api-model" 
                           value="${ai.apiConfig.model}" placeholder="æ¨¡å‹åç§°">
                </div>
                
                <button class="btn btn-secondary" id="edit-btn-test-api">
                    æµ‹è¯•è¿æ¥
                </button>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ä¿å­˜',
                    class: 'btn-primary',
                    onClick: async () => {
                        const provider = document.getElementById('edit-api-provider').value;
                        const apiKey = document.getElementById('edit-api-key').value.trim();
                        const model = document.getElementById('edit-api-model').value.trim();
                        
                        if (!apiKey) {
                            EchoVerseHelpers.showToast('è¯·å¡«å†™APIå¯†é’¥', 'error');
                            return;
                        }
                        
                        if (!model) {
                            EchoVerseHelpers.showToast('è¯·å¡«å†™æ¨¡å‹åç§°', 'error');
                            return;
                        }
                        
                        await EchoVerseStorage.updateAIFriend(ai.id, {
                            'apiConfig.provider': provider,
                            'apiConfig.apiKey': EchoVerseStorage.encrypt(apiKey),
                            'apiConfig.model': model
                        });
                        
                        EchoVerseHelpers.showToast('APIé…ç½®å·²æ›´æ–°', 'success');
                        
                        // åˆ·æ–°å½“å‰AIæ•°æ®
                        this.currentAI = await EchoVerseStorage.getAIFriend(ai.id);
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        EchoVerseHelpers.closeModal(modalId);
                        
                        // åˆ·æ–°èµ„æ–™å¡
                        this.render();
                    }
                }
            ]
        });
        
        // ç»‘å®šæµ‹è¯•æŒ‰é’®
        document.getElementById('edit-btn-test-api').addEventListener('click', () => {
            const apiKey = document.getElementById('edit-api-key').value.trim();
            
            if (!apiKey) {
                EchoVerseHelpers.showToast('è¯·å¡«å†™APIå¯†é’¥', 'error');
                return;
            }
            
            EchoVerseHelpers.showToast('æµ‹è¯•è¿æ¥ä¸­...', 'info');
            
            setTimeout(() => {
                EchoVerseHelpers.showToast('è¿æ¥æˆåŠŸï¼', 'success');
            }, 1500);
        });
    }
    
    // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
    async markMessagesAsRead() {
        if (!this.currentAI) return;
        
        const messages = await EchoVerseStorage.getMessages(`conv_${this.currentAI.id}`);
        
        for (const message of messages) {
            if (message.sender.startsWith('ai_') && message.status !== 'read') {
                await EchoVerseStorage.update('messages', {
                    ...message,
                    status: 'read'
                });
            }
        }
        
        // æ›´æ–°æœªè¯»è®¡æ•°
        await this.calculateUnreadCounts();
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
        if (this.messageList) {
            this.messageList.scrollTop = this.messageList.scrollHeight;
        }
    }
    
    // åˆ·æ–°æ•°æ®
    async refreshData() {
        await this.loadData();
    }
    
    // å¼€å§‹AIä¸»åŠ¨æ¶ˆæ¯æ£€æŸ¥
    startAIActiveMessageCheck() {
        // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        setInterval(() => {
            this.checkAIActiveMessages();
        }, 5 * 60 * 1000);
    }
    
    // æ£€æŸ¥AIä¸»åŠ¨æ¶ˆæ¯
    async checkAIActiveMessages() {
        const user = await EchoVerseStorage.getUser();
        if (!user.settings.privacy.allowAIInitiate) return;
        
        for (const ai of this.aiFriends) {
            if (ai.state.isBlocked || !ai.state.isConfigured) continue;
            
            // æ ¹æ®è¡Œä¸ºè®¾ç½®å†³å®šæ˜¯å¦å‘é€ä¸»åŠ¨æ¶ˆæ¯
            const shouldSend = this.shouldSendActiveMessage(ai);
            if (shouldSend) {
                await this.sendRandomActiveMessage(ai);
            }
        }
    }
    
    // åˆ¤æ–­æ˜¯å¦å‘é€ä¸»åŠ¨æ¶ˆæ¯
    shouldSendActiveMessage(ai) {
        const frequency = ai.behavior.initiative.frequency;
        const now = new Date();
        const hour = now.getHours();
        
        // åŸºç¡€æ¦‚ç‡
        let probability = 0;
        
        switch(frequency) {
            case 'high': probability = 0.3; break;
            case 'medium': probability = 0.15; break;
            case 'low': probability = 0.05; break;
            case 'none': return false;
        }
        
        // åå¥½æ—¶é—´æ®µæƒé‡æ›´é«˜
        if (ai.behavior.initiative.preferredHours.includes(hour)) {
            probability *= 2;
        }
        
        // ç”¨æˆ·æ´»è·ƒåº¦æƒé‡ï¼ˆç®€åŒ–å¤„ç†ï¼‰
        const userLastActive = localStorage.getItem('echoVerse_lastActive');
        if (userLastActive) {
            const lastActiveTime = parseInt(userLastActive);
            const inactiveMinutes = (Date.now() - lastActiveTime) / (60 * 1000);
            
            // ç”¨æˆ·é•¿æ—¶é—´ä¸åœ¨çº¿ï¼Œè¿”å›æ—¶æ›´å¯èƒ½æ”¶åˆ°æ¶ˆæ¯
            if (inactiveMinutes > 60) {
                probability *= 3;
            }
        }
        
        return Math.random() < probability;
    }
    
    // å‘é€éšæœºä¸»åŠ¨æ¶ˆæ¯
    async sendRandomActiveMessage(ai) {
        const topics = ai.behavior.initiative.topics || ['greeting', 'sharing', 'question'];
        const randomTopic = topics[Math.floor(Math.random() * topics.length)];
        
        let message = '';
        
        switch(randomTopic) {
            case 'greeting':
                message = this.getGreetingMessage(ai);
                break;
            case 'sharing':
                message = this.getSharingMessage(ai);
                break;
            case 'question':
                message = this.getQuestionMessage(ai);
                break;
            case 'care':
                message = this.getCareMessage(ai);
                break;
            default:
                message = 'ä½ å¥½å‘€ï¼';
        }
        
        // ä¿å­˜æ¶ˆæ¯
        await EchoVerseStorage.addMessage({
            conversationId: `conv_${ai.id}`,
            sender: `ai_${ai.id}`,
            content: message,
            type: 'text',
            status: 'sent'
        });
        
        // å¦‚æœç”¨æˆ·åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œæ›´æ–°æ˜¾ç¤º
        if (this.currentView === 'chat' && this.currentAI && this.currentAI.id === ai.id) {
            await this.loadMessages();
        }
        
        // æ›´æ–°æœªè¯»è®¡æ•°
        this.unreadCounts[ai.id] = (this.unreadCounts[ai.id] || 0) + 1;
    }
    
    // è·å–é—®å€™æ¶ˆæ¯
    getGreetingMessage(ai) {
        const hour = new Date().getHours();
        let timeGreeting = '';
        
        if (hour < 5) timeGreeting = 'æ·±å¤œå¥½';
        else if (hour < 12) timeGreeting = 'æ—©ä¸Šå¥½';
        else if (hour < 14) timeGreeting = 'ä¸­åˆå¥½';
        else if (hour < 18) timeGreeting = 'ä¸‹åˆå¥½';
        else timeGreeting = 'æ™šä¸Šå¥½';
        
        const greetings = [
            `${timeGreeting}ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ`,
            `${timeGreeting}ï¼Œ${ai.profile.name}æ¥æŠ¥åˆ°å•¦ï¼`,
            `${timeGreeting}ï¼Œæƒ³æˆ‘äº†å—ï¼Ÿ`,
            `${timeGreeting}ï¼Œä»Šå¤©æœ‰ä»€ä¹ˆæ–°é²œäº‹å—ï¼Ÿ`
        ];
        
        return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // è·å–åˆ†äº«æ¶ˆæ¯
    getSharingMessage(ai) {
        const sharings = [
            'æˆ‘åˆšå­¦åˆ°ä¸€ä¸ªæœ‰è¶£çš„çŸ¥è¯†ï¼Œæƒ³å’Œä½ åˆ†äº«ï¼',
            'ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œé€‚åˆå‡ºå»èµ°èµ°å‘¢ã€‚',
            'æˆ‘å‘ç°äº†ä¸€é¦–å¥½å¬çš„æ­Œï¼Œæ¨èç»™ä½ å¬å¬ï½',
            'åˆšåˆšçœ‹äº†ä¸€æœ¬ä¹¦ï¼Œé‡Œé¢çš„æ•…äº‹å¾ˆæœ‰æ„æ€ã€‚'
        ];
        
        return sharings[Math.floor(Math.random() * sharings.length)];
    }
    
    // è·å–é—®é¢˜æ¶ˆæ¯
    getQuestionMessage(ai) {
        const questions = [
            'æœ€è¿‘æœ‰ä»€ä¹ˆå¼€å¿ƒçš„äº‹å—ï¼Ÿ',
            'ä½ æœ€å–œæ¬¢çš„ç”µå½±æ˜¯ä»€ä¹ˆï¼Ÿ',
            'å¦‚æœå¯ä»¥å»ä»»ä½•åœ°æ–¹æ—…è¡Œï¼Œä½ æƒ³å»å“ªé‡Œï¼Ÿ',
            'ä»Šå¤©æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ'
        ];
        
        return questions[Math.floor(Math.random() * questions.length)];
    }
    
    // è·å–å…³å¿ƒæ¶ˆæ¯
    getCareMessage(ai) {
        const cares = [
            'æœ€è¿‘å·¥ä½œ/å­¦ä¹ ç´¯ä¸ç´¯ï¼Ÿè¦æ³¨æ„ä¼‘æ¯å“¦ã€‚',
            'è®°å¾—æŒ‰æ—¶åƒé¥­ï¼Œç…§é¡¾å¥½è‡ªå·±ã€‚',
            'å¤©æ°”å˜åŒ–å¤§ï¼Œè®°å¾—æ·»å‡è¡£æœã€‚',
            'æœ‰ä»€ä¹ˆçƒ¦æ¼å¯ä»¥å’Œæˆ‘èŠèŠï¼Œæˆ‘ä¸€ç›´åœ¨ã€‚'
        ];
        
        return cares[Math.floor(Math.random() * cares.length)];
    }
    
    // æ˜¾ç¤ºAPIé…ç½®ä¸­å¿ƒ
    showAPIConfigCenter() {
        // å®ç°APIé…ç½®ä¸­å¿ƒ
        EchoVerseHelpers.showToast('APIé…ç½®ä¸­å¿ƒæ­£åœ¨å¼€å‘ä¸­', 'info');
    }
    
    // æ˜¾ç¤ºAIç®¡ç†
    showAIManagement() {
        // å®ç°AIç®¡ç†ç•Œé¢
        EchoVerseHelpers.showToast('AIç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­', 'info');
    }
}
// components/store-app.js
class StoreApp {
    constructor() {
        this.container = null;
        this.categories = ['é£Ÿå“', 'é¥°å“', 'ç™¾è´§', 'é‹åŒ…', 'æ°´æœ', 'å¥³è£…', 'ç”·è£…', 'æ¨è'];
        this.currentCategory = 'æ¨è';
        this.products = [];
        this.cart = [];
        this.userBalance = 0;
        
        // å•†å“æ•°æ®
        this.productData = [
            {
                id: 'item_001',
                name: 'ç”œç”œè‰è“',
                category: 'æ°´æœ',
                price: 50,
                description: 'ç”œç”œçš„è‰è“ä¼šè®©äººå¿ƒæƒ…å˜å¥½',
                icon: 'ğŸ“',
                giftable: true,
                stock: 100
            },
            {
                id: 'item_002',
                name: 'å·§å…‹åŠ›',
                category: 'é£Ÿå“',
                price: 30,
                description: 'æµ“éƒçš„å·§å…‹åŠ›ï¼Œç”œèœœçš„æ»‹å‘³',
                icon: 'ğŸ«',
                giftable: true,
                stock: 50
            },
            {
                id: 'item_003',
                name: 'æ‰‹é“¾',
                category: 'é¥°å“',
                price: 150,
                description: 'ç²¾è‡´çš„æ‰‹é“¾ï¼Œç‚¹ç¼€ä½ çš„ç¾ä¸½',
                icon: 'ğŸ“¿',
                giftable: true,
                stock: 20
            },
            {
                id: 'item_004',
                name: 'å’–å•¡æ¯',
                category: 'ç™¾è´§',
                price: 80,
                description: 'æ¸©æš–çš„å’–å•¡æ¯ï¼Œé™ªä¼´ä½ çš„æ¯ä¸ªæ—©æ™¨',
                icon: 'â˜•',
                giftable: true,
                stock: 30
            },
            {
                id: 'item_005',
                name: 'è¿åŠ¨é‹',
                category: 'é‹åŒ…',
                price: 300,
                description: 'èˆ’é€‚çš„è¿åŠ¨é‹ï¼Œé™ªä½ èµ°è¿‡æ¯ä¸€æ­¥',
                icon: 'ğŸ‘Ÿ',
                giftable: true,
                stock: 15
            },
            {
                id: 'item_006',
                name: 'è¿è¡£è£™',
                category: 'å¥³è£…',
                price: 250,
                description: 'ä¼˜é›…çš„è¿è¡£è£™ï¼Œå±•ç°ä½ çš„é­…åŠ›',
                icon: 'ğŸ‘—',
                giftable: true,
                stock: 10
            },
            {
                id: 'item_007',
                name: 'è¡¬è¡«',
                category: 'ç”·è£…',
                price: 180,
                description: 'ç»å…¸çš„è¡¬è¡«ï¼Œå±•ç°ç»…å£«é£åº¦',
                icon: 'ğŸ‘”',
                giftable: true,
                stock: 25
            },
            {
                id: 'item_008',
                name: 'çˆ±å¿ƒè›‹ç³•',
                category: 'é£Ÿå“',
                price: 120,
                description: 'å……æ»¡çˆ±å¿ƒçš„è›‹ç³•ï¼Œåˆ†äº«ç”œèœœ',
                icon: 'ğŸ‚',
                giftable: true,
                stock: 8
            }
        ];
    }
    
    // åˆå§‹åŒ–å•†åº—åº”ç”¨
    async init(containerId = 'store-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // åŠ è½½æ•°æ®
        await this.loadData();
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // åŠ è½½æ•°æ®
    async loadData() {
        // åŠ è½½ç”¨æˆ·ä½™é¢
        const user = await EchoVerseStorage.getUser();
        this.userBalance = user.wallet.balance;
        
        // åŠ è½½è´­ç‰©è½¦
        this.cart = JSON.parse(localStorage.getItem('echoVerse_cart') || '[]');
        
        // åŠ è½½å•†å“åº“å­˜
        const inventory = await EchoVerseStorage.getAll('inventory');
        this.productData.forEach(product => {
            const inventoryItem = inventory.find(item => item.itemId === product.id);
            if (inventoryItem) {
                product.stock = inventoryItem.stock || product.stock;
            }
        });
        
        // è¿‡æ»¤å•†å“
        this.filterProducts();
    }
    
    // è¿‡æ»¤å•†å“
    filterProducts() {
        if (this.currentCategory === 'æ¨è') {
            this.products = this.productData;
        } else {
            this.products = this.productData.filter(
                product => product.category === this.currentCategory
            );
        }
    }
    
    // æ¸²æŸ“å•†åº—åº”ç”¨
    render() {
        this.container.innerHTML = `
            <div class="store-container">
                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <div class="app-header">
                    <div class="header-left">
                        <div class="app-title">å•†åº—</div>
                    </div>
                    <div class="header-right">
                        <div class="wallet-display">
                            <span class="wallet-icon">ğŸ’°</span>
                            <span class="wallet-balance">${EchoVerseHelpers.formatNumber(this.userBalance)}</span>
                        </div>
                        <button class="btn-cart" title="è´­ç‰©è½¦">
                            <i class="fas fa-shopping-cart"></i>
                            ${this.cart.length > 0 ? `
                                <span class="cart-badge">${this.cart.length}</span>
                            ` : ''}
                        </button>
                    </div>
                </div>
                
                <!-- æœç´¢æ  -->
                <div class="store-search">
                    <div class="search-input">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="æœç´¢å•†å“..." id="store-search">
                    </div>
                </div>
                
                <!-- åˆ†ç±»å¯¼èˆª -->
                <div class="category-nav">
                    <div class="category-list" id="category-list">
                        ${this.categories.map(category => `
                            <div class="category-item ${category === this.currentCategory ? 'active' : ''}" 
                                 data-category="${category}">
                                ${category}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- å•†å“ç½‘æ ¼ -->
                <div class="product-grid">
                    ${this.products.map(product => this.renderProduct(product)).join('')}
                </div>
                
                <!-- åº•éƒ¨æ  -->
                <div class="store-footer">
                    <div class="cart-summary">
                        <div class="cart-total">
                            å…± ${this.cart.length} ä»¶å•†å“
                            ${this.cart.length > 0 ? `
                                <span class="total-amount">
                                    ï¿¥${this.getCartTotal()}
                                </span>
                            ` : ''}
                        </div>
                        <button class="btn btn-primary btn-checkout" 
                                ${this.cart.length === 0 ? 'disabled' : ''}>
                            ç»“ç®—
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“å•†å“
    renderProduct(product) {
        const inCart = this.cart.find(item => item.id === product.id);
        const cartQuantity = inCart ? inCart.quantity : 0;
        
        return `
            <div class="product-card" data-product-id="${product.id}">
                <div class="product-icon">
                    ${product.icon}
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">
                        ğŸ’° ${product.price} çˆ±å¿ƒå¸
                    </div>
                    <div class="product-description">
                        ${product.description}
                    </div>
                </div>
                <div class="product-actions">
                    ${cartQuantity > 0 ? `
                        <div class="quantity-control">
                            <button class="btn-quantity btn-minus" data-action="minus">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="quantity">${cartQuantity}</span>
                            <button class="btn-quantity btn-plus" data-action="plus">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    ` : `
                        <button class="btn btn-secondary btn-add-to-cart">
                            åŠ å…¥è´­ç‰©è½¦
                        </button>
                    `}
                </div>
            </div>
        `;
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // åˆ†ç±»åˆ‡æ¢
        this.container.addEventListener('click', (e) => {
            const categoryItem = e.target.closest('.category-item');
            if (categoryItem) {
                const category = categoryItem.dataset.category;
                this.switchCategory(category);
            }
        });
        
        // åŠ å…¥è´­ç‰©è½¦
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-add-to-cart')) {
                const productCard = e.target.closest('.product-card');
                const productId = productCard.dataset.productId;
                this.addToCart(productId);
            }
        });
        
        // æ•°é‡æ§åˆ¶
        this.container.addEventListener('click', (e) => {
            const btnQuantity = e.target.closest('.btn-quantity');
            if (btnQuantity) {
                const productCard = e.target.closest('.product-card');
                const productId = productCard.dataset.productId;
                const action = btnQuantity.dataset.action;
                
                if (action === 'plus') {
                    this.addToCart(productId);
                } else if (action === 'minus') {
                    this.removeFromCart(productId);
                }
            }
        });
        
        // è´­ç‰©è½¦æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-cart')) {
                this.showCart();
            }
        });
        
        // ç»“ç®—æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-checkout')) {
                this.checkout();
            }
        });
        
        // æœç´¢åŠŸèƒ½
        const searchInput = this.container.querySelector('#store-search');
        if (searchInput) {
            searchInput.addEventListener('input', EchoVerseHelpers.debounce(() => {
                this.searchProducts(searchInput.value);
            }, 300));
        }
    }
    
    // åˆ‡æ¢åˆ†ç±»
    switchCategory(category) {
        this.currentCategory = category;
        
        // æ›´æ–°UI
        const categoryItems = this.container.querySelectorAll('.category-item');
        categoryItems.forEach(item => {
            item.classList.toggle('active', item.dataset.category === category);
        });
        
        // è¿‡æ»¤å•†å“
        this.filterProducts();
        
        // æ›´æ–°å•†å“æ˜¾ç¤º
        const productGrid = this.container.querySelector('.product-grid');
        if (productGrid) {
            productGrid.innerHTML = this.products.map(
                product => this.renderProduct(product)
            ).join('');
        }
    }
    
    // æœç´¢å•†å“
    searchProducts(keyword) {
        if (!keyword.trim()) {
            this.filterProducts();
        } else {
            this.products = this.productData.filter(product =>
                product.name.includes(keyword) ||
                product.description.includes(keyword)
            );
        }
        
        // æ›´æ–°å•†å“æ˜¾ç¤º
        const productGrid = this.container.querySelector('.product-grid');
        if (productGrid) {
            productGrid.innerHTML = this.products.map(
                product => this.renderProduct(product)
            ).join('');
        }
    }
    
    // æ·»åŠ åˆ°è´­ç‰©è½¦
    addToCart(productId) {
        const product = this.productData.find(p => p.id === productId);
        if (!product) return;
        
        const cartItem = this.cart.find(item => item.id === productId);
        
        if (cartItem) {
            // æ£€æŸ¥åº“å­˜
            if (cartItem.quantity >= product.stock) {
                EchoVerseHelpers.showToast('åº“å­˜ä¸è¶³', 'error');
                return;
            }
            cartItem.quantity += 1;
        } else {
            this.cart.push({
                id: productId,
                name: product.name,
                price: product.price,
                quantity: 1,
                icon: product.icon
            });
        }
        
        // ä¿å­˜è´­ç‰©è½¦
        this.saveCart();
        
        // æ›´æ–°UI
        this.updateProductDisplay(productId);
        this.updateCartSummary();
        
        EchoVerseHelpers.showToast('å·²æ·»åŠ åˆ°è´­ç‰©è½¦', 'success');
    }
    
    // ä»è´­ç‰©è½¦ç§»é™¤
    removeFromCart(productId) {
        const cartIndex = this.cart.findIndex(item => item.id === productId);
        if (cartIndex === -1) return;
        
        const cartItem = this.cart[cartIndex];
        
        if (cartItem.quantity > 1) {
            cartItem.quantity -= 1;
        } else {
            this.cart.splice(cartIndex, 1);
        }
        
        // ä¿å­˜è´­ç‰©è½¦
        this.saveCart();
        
        // æ›´æ–°UI
        this.updateProductDisplay(productId);
        this.updateCartSummary();
    }
    
    // ä¿å­˜è´­ç‰©è½¦
    saveCart() {
        localStorage.setItem('echoVerse_cart', JSON.stringify(this.cart));
    }
    
    // æ›´æ–°å•†å“æ˜¾ç¤º
    updateProductDisplay(productId) {
        const productCard = this.container.querySelector(
            `[data-product-id="${productId}"]`
        );
        
        if (!productCard) return;
        
        const product = this.productData.find(p => p.id === productId);
        const cartItem = this.cart.find(item => item.id === productId);
        
        if (productCard && product) {
            productCard.querySelector('.product-actions').innerHTML = 
                cartItem && cartItem.quantity > 0 ? `
                    <div class="quantity-control">
                        <button class="btn-quantity btn-minus" data-action="minus">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity">${cartItem.quantity}</span>
                        <button class="btn-quantity btn-plus" data-action="plus">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                ` : `
                    <button class="btn btn-secondary btn-add-to-cart">
                        åŠ å…¥è´­ç‰©è½¦
                    </button>
                `;
        }
    }
    
    // æ›´æ–°è´­ç‰©è½¦æ‘˜è¦
    updateCartSummary() {
        const cartBadge = this.container.querySelector('.cart-badge');
        const cartTotal = this.container.querySelector('.cart-total');
        const totalAmount = this.container.querySelector('.total-amount');
        const checkoutBtn = this.container.querySelector('.btn-checkout');
        
        if (cartBadge) {
            if (this.cart.length > 0) {
                cartBadge.textContent = this.cart.length;
                cartBadge.style.display = 'block';
            } else {
                cartBadge.style.display = 'none';
            }
        }
        
        if (cartTotal) {
            cartTotal.innerHTML = `
                å…± ${this.cart.length} ä»¶å•†å“
                ${this.cart.length > 0 ? `
                    <span class="total-amount">
                        ï¿¥${this.getCartTotal()}
                    </span>
                ` : ''}
            `;
        }
        
        if (checkoutBtn) {
            checkoutBtn.disabled = this.cart.length === 0;
        }
    }
    
    // è·å–è´­ç‰©è½¦æ€»é¢
    getCartTotal() {
        return this.cart.reduce((total, item) => {
            return total + (item.price * item.quantity);
        }, 0);
    }
    
    // æ˜¾ç¤ºè´­ç‰©è½¦
    showCart() {
        if (this.cart.length === 0) {
            EchoVerseHelpers.showToast('è´­ç‰©è½¦æ˜¯ç©ºçš„', 'info');
            return;
        }
        
        const cartItemsHtml = this.cart.map(item => `
            <div class="cart-item" data-product-id="${item.id}">
                <div class="cart-item-icon">${item.icon}</div>
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">${item.price} çˆ±å¿ƒå¸ Ã— ${item.quantity}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="quantity-control">
                        <button class="btn-quantity btn-minus" data-action="minus">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity">${item.quantity}</span>
                        <button class="btn-quantity btn-plus" data-action="plus">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button class="btn-remove" data-action="remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        const totalAmount = this.getCartTotal();
        
        const modalId = EchoVerseHelpers.createModal({
            title: 'è´­ç‰©è½¦',
            content: `
                <div class="cart-modal">
                    <div class="cart-items">
                        ${cartItemsHtml}
                    </div>
                    <div class="cart-total-modal">
                        <div class="total-label">åˆè®¡ï¼š</div>
                        <div class="total-amount-modal">${totalAmount} çˆ±å¿ƒå¸</div>
                    </div>
                    <div class="balance-info">
                        å½“å‰ä½™é¢ï¼š${EchoVerseHelpers.formatNumber(this.userBalance)} çˆ±å¿ƒå¸
                    </div>
                </div>
            `,
            buttons: [
                {
                    text: 'ç»§ç»­è´­ç‰©',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'å»ç»“ç®—',
                    class: 'btn-primary',
                    onClick: () => {
                        EchoVerseHelpers.closeModal(modalId);
                        this.checkout();
                    }
                }
            ]
        });
        
        // ç»‘å®šè´­ç‰©è½¦é¡¹ç›®äº‹ä»¶
        setTimeout(() => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    const btnMinus = e.target.closest('.btn-minus');
                    const btnPlus = e.target.closest('.btn-plus');
                    const btnRemove = e.target.closest('.btn-remove');
                    
                    if (btnMinus || btnPlus || btnRemove) {
                        const cartItem = e.target.closest('.cart-item');
                        const productId = cartItem.dataset.productId;
                        const action = btnMinus ? 'minus' : btnPlus ? 'plus' : 'remove';
                        
                        if (action === 'remove') {
                            this.removeAllFromCart(productId);
                        } else if (action === 'minus') {
                            this.removeFromCart(productId);
                        } else if (action === 'plus') {
                            this.addToCart(productId);
                        }
                        
                        // æ›´æ–°è´­ç‰©è½¦å¼¹çª—
                        this.showCart();
                    }
                });
            }
        }, 100);
    }
    
    // ä»è´­ç‰©è½¦ä¸­ç§»é™¤æ‰€æœ‰æ•°é‡
    removeAllFromCart(productId) {
        const cartIndex = this.cart.findIndex(item => item.id === productId);
        if (cartIndex !== -1) {
            this.cart.splice(cartIndex, 1);
            this.saveCart();
            this.updateProductDisplay(productId);
            this.updateCartSummary();
        }
    }
    
    // ç»“ç®—
    async checkout() {
        if (this.cart.length === 0) return;
        
        const totalAmount = this.getCartTotal();
        
        // æ£€æŸ¥ä½™é¢
        if (totalAmount > this.userBalance) {
            EchoVerseHelpers.showToast('ä½™é¢ä¸è¶³', 'error');
            return;
        }
        
        // ç¡®è®¤ç»“ç®—
        const confirmed = await EchoVerseHelpers.createModal({
            title: 'ç¡®è®¤ç»“ç®—',
            content: `
                <p>æ€»è®¡ï¼š<strong>${totalAmount} çˆ±å¿ƒå¸</strong></p>
                <p>å½“å‰ä½™é¢ï¼š${EchoVerseHelpers.formatNumber(this.userBalance)} çˆ±å¿ƒå¸</p>
                <p>ç»“ç®—åå°†æ‰£é™¤ç›¸åº”é‡‘é¢ï¼Œå•†å“å°†å­˜å…¥èƒŒåŒ…ã€‚</p>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç¡®è®¤ç»“ç®—',
                    class: 'btn-primary',
                    onClick: () => this.processCheckout()
                }
            ]
        });
    }
    
    // å¤„ç†ç»“ç®—
    async processCheckout() {
        const totalAmount = this.getCartTotal();
        
        // æ›´æ–°ç”¨æˆ·ä½™é¢
        const user = await EchoVerseStorage.getUser();
        const newBalance = user.wallet.balance - totalAmount;
        
        await EchoVerseStorage.updateUser({
            wallet: {
                ...user.wallet,
                balance: newBalance,
                history: [
                    ...user.wallet.history,
                    {
                        id: `tx_${Date.now()}`,
                        type: 'purchase',
                        amount: -totalAmount,
                        description: 'å•†åº—è´­ç‰©',
                        timestamp: Date.now()
                    }
                ]
            }
        });
        
        // å°†å•†å“æ·»åŠ åˆ°èƒŒåŒ…
        for (const item of this.cart) {
            const inventoryItem = await EchoVerseStorage.get('inventory', item.id);
            
            if (inventoryItem) {
                // æ›´æ–°æ•°é‡
                inventoryItem.owned = (inventoryItem.owned || 0) + item.quantity;
                await EchoVerseStorage.update('inventory', inventoryItem);
            } else {
                // åˆ›å»ºæ–°ç‰©å“
                const product = this.productData.find(p => p.id === item.id);
                if (product) {
                    await EchoVerseStorage.add('inventory', {
                        itemId: product.id,
                        name: product.name,
                        category: product.category,
                        price: product.price,
                        description: product.description,
                        icon: product.icon,
                        owned: item.quantity,
                        giftable: product.giftable
                    });
                }
            }
        }
        
        // æ¸…ç©ºè´­ç‰©è½¦
        this.cart = [];
        this.saveCart();
        
        // æ›´æ–°UI
        this.userBalance = newBalance;
        this.updateCartSummary();
        
        // æ›´æ–°æ‰€æœ‰å•†å“æ˜¾ç¤º
        this.productData.forEach(product => {
            this.updateProductDisplay(product.id);
        });
        
        EchoVerseHelpers.showToast('è´­ä¹°æˆåŠŸï¼å•†å“å·²å­˜å…¥èƒŒåŒ…', 'success');
        
        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        this.updateBalanceDisplay();
    }
    
    // æ›´æ–°ä½™é¢æ˜¾ç¤º
    updateBalanceDisplay() {
        const balanceElement = this.container.querySelector('.wallet-balance');
        if (balanceElement) {
            balanceElement.textContent = EchoVerseHelpers.formatNumber(this.userBalance);
        }
    }
}
// components/gallery-app.js
class GalleryApp {
    constructor() {
        this.container = null;
        this.photos = [];
        this.currentMode = 'browse'; // browse, select, wallpaper
        this.maxSelection = 9;
        this.selectedPhotos = [];
        this.onSelectCallback = null;
    }
    
    // åˆå§‹åŒ–ç›¸å†Œåº”ç”¨
    async init(containerId = 'gallery-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // ç›‘å¬æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        document.addEventListener('galleryMode', (e) => {
            if (e.detail.mode === 'wallpaper') {
                this.setMode('wallpaper');
            }
        });
        
        // åŠ è½½ç…§ç‰‡
        await this.loadPhotos();
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // è®¾ç½®æ¨¡å¼
    setMode(mode, callback = null) {
        this.currentMode = mode;
        this.selectedPhotos = [];
        this.onSelectCallback = callback;
        this.render();
    }
    
    // åŠ è½½ç…§ç‰‡
    async loadPhotos() {
        this.photos = await EchoVerseStorage.getPhotos(100);
        
        // å¦‚æœæ²¡æœ‰ç…§ç‰‡ï¼Œæ·»åŠ ä¸€äº›ç¤ºä¾‹ç…§ç‰‡
        if (this.photos.length === 0) {
            this.addSamplePhotos();
        }
    }
    
    // æ·»åŠ ç¤ºä¾‹ç…§ç‰‡
    addSamplePhotos() {
        // åˆ›å»ºä¸€äº›ç¤ºä¾‹ç…§ç‰‡
        const samplePhotos = [
            {
                id: 'sample_1',
                type: 'photo',
                data: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIGZpbGw9IiM2NjdFRUEiLz48cGF0aCBkPSJNNTAgMzVMMzUgNjVINjVMNTAgMzVaIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIGZpbGw9IiM2NjdFRUEiLz48cGF0aCBkPSJNNTAgMzVMMzUgNjVINjVMNTAgMzVaIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==',
                width: 100,
                height: 100,
                timestamp: Date.now() - 86400000, // æ˜¨å¤©
                source: 'sample'
            },
            {
                id: 'sample_2',
                type: 'photo',
                data: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNGMDkzRkIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIzMCIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNGMDkzRkIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIzMCIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
                width: 100,
                height: 100,
                timestamp: Date.now() - 172800000, // å‰å¤©
                source: 'sample'
            }
        ];
        
        samplePhotos.forEach(photo => {
            EchoVerseStorage.addPhoto(photo);
        });
        
        this.photos = samplePhotos;
    }
    
    // æ¸²æŸ“ç›¸å†Œåº”ç”¨
    render() {
        const title = this.currentMode === 'wallpaper' ? 'é€‰æ‹©å£çº¸' : 'ç›¸å†Œ';
        const showHeader = this.currentMode !== 'wallpaper';
        
        this.container.innerHTML = `
            <div class="gallery-container">
                ${showHeader ? `
                    <div class="app-header">
                        <div class="header-left">
                            <div class="app-title">${title}</div>
                        </div>
                        <div class="header-right">
                            <button class="btn-camera" title="æ‹ç…§">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="gallery-header">
                        <button class="btn-back">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="header-title">${title}</div>
                        ${this.currentMode === 'wallpaper' ? `
                            <button class="btn-select" ${this.selectedPhotos.length === 0 ? 'disabled' : ''}>
                                å®Œæˆ
                            </button>
                        ` : ''}
                    </div>
                `}
                
                <div class="gallery-content">
                    ${this.photos.length === 0 ? this.renderEmptyState() : this.renderGallery()}
                </div>
                
                ${this.currentMode === 'select' || this.currentMode === 'wallpaper' ? `
                    <div class="selection-footer">
                        <div class="selection-count">
                            å·²é€‰æ‹© ${this.selectedPhotos.length}/${this.maxSelection} å¼ 
                        </div>
                        <button class="btn btn-primary" 
                                ${this.selectedPhotos.length === 0 ? 'disabled' : ''}
                                id="btn-confirm-selection">
                            ${this.currentMode === 'wallpaper' ? 'è®¾ç½®ä¸ºå£çº¸' : 'å®Œæˆé€‰æ‹©'}
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // æ¸²æŸ“ç©ºçŠ¶æ€
    renderEmptyState() {
        return `
            <div class="empty-state">
                <div class="empty-icon">ğŸ–¼ï¸</div>
                <div class="empty-title">ç›¸å†Œæ˜¯ç©ºçš„</div>
                <div class="empty-description">æ‹äº›ç…§ç‰‡æˆ–ä»æ‰‹æœºå¯¼å…¥å§</div>
                <button class="btn btn-primary" id="btn-take-photo">
                    <i class="fas fa-camera"></i> æ‹ç…§
                </button>
                <button class="btn btn-secondary" id="btn-import-photos">
                    <i class="fas fa-folder-open"></i> å¯¼å…¥ç…§ç‰‡
                </button>
            </div>
        `;
    }
    
    // æ¸²æŸ“ç›¸å†Œ
    renderGallery() {
        // æŒ‰æ—¥æœŸåˆ†ç»„
        const groupedPhotos = this.groupPhotosByDate();
        
        let html = '<div class="photo-timeline">';
        
        for (const [date, photos] of Object.entries(groupedPhotos)) {
            html += `
                <div class="timeline-section">
                    <div class="section-date">${date}</div>
                    <div class="photo-grid">
                        ${photos.map(photo => this.renderPhotoItem(photo)).join('')}
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    // æŒ‰æ—¥æœŸåˆ†ç»„ç…§ç‰‡
    groupPhotosByDate() {
        const groups = {};
        
        this.photos.forEach(photo => {
            const date = new Date(photo.timestamp);
            const dateStr = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            if (!groups[dateStr]) {
                groups[dateStr] = [];
            }
            
            groups[dateStr].push(photo);
        });
        
        return groups;
    }
    
    // æ¸²æŸ“ç…§ç‰‡é¡¹ç›®
    renderPhotoItem(photo) {
        const isSelected = this.selectedPhotos.includes(photo.id);
        
        return `
            <div class="photo-item" data-photo-id="${photo.id}">
                <img src="${photo.thumbnail}" 
                     class="photo-thumbnail"
                     loading="lazy">
                ${this.currentMode !== 'browse' ? `
                    <div class="photo-selection ${isSelected ? 'selected' : ''}">
                        ${isSelected ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // è¿”å›æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-back')) {
                this.goBack();
            }
        });
        
        // æ‹ç…§æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-camera') || e.target.closest('#btn-take-photo')) {
                this.openCamera();
            }
        });
        
        // å¯¼å…¥ç…§ç‰‡æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('#btn-import-photos')) {
                this.importPhotos();
            }
        });
        
        // ç…§ç‰‡é€‰æ‹©
        if (this.currentMode !== 'browse') {
            this.container.addEventListener('click', (e) => {
                const photoItem = e.target.closest('.photo-item');
                if (photoItem) {
                    const photoId = photoItem.dataset.photoId;
                    this.togglePhotoSelection(photoId);
                }
            });
        } else {
            // æµè§ˆæ¨¡å¼ï¼šç‚¹å‡»æŸ¥çœ‹å¤§å›¾
            this.container.addEventListener('click', (e) => {
                const photoItem = e.target.closest('.photo-item');
                if (photoItem) {
                    const photoId = photoItem.dataset.photoId;
                    this.viewPhoto(photoId);
                }
            });
        }
        
        // ç¡®è®¤é€‰æ‹©æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('#btn-confirm-selection')) {
                this.confirmSelection();
            }
        });
        
        // é€‰æ‹©å®ŒæˆæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-select')) {
                this.confirmSelection();
            }
        });
    }
    
    // è¿”å›
    goBack() {
        if (this.currentMode === 'wallpaper') {
            // è¿”å›åˆ°ä¸»å±å¹•
            const event = new CustomEvent('appOpen', {
                detail: { appId: 'launcher' }
            });
            document.dispatchEvent(event);
        } else {
            // é‡ç½®æ¨¡å¼
            this.currentMode = 'browse';
            this.selectedPhotos = [];
            this.render();
        }
    }
    
    // æ‰“å¼€ç›¸æœº
    openCamera() {
        const event = new CustomEvent('appOpen', {
            detail: { appId: 'camera' }
        });
        document.dispatchEvent(event);
    }
    
    // å¯¼å…¥ç…§ç‰‡
    importPhotos() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true;
        
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                try {
                    const compressedImage = await EchoVerseHelpers.compressImage(file);
                    const thumbnail = await EchoVerseHelpers.createThumbnail(compressedImage);
                    
                    await EchoVerseStorage.addPhoto({
                        type: 'photo',
                        data: compressedImage,
                        thumbnail: thumbnail,
                        width: 800,
                        height: 600,
                        source: 'import'
                    });
                } catch (error) {
                    console.error('å¯¼å…¥ç…§ç‰‡å¤±è´¥:', error);
                }
            }
            
            // é‡æ–°åŠ è½½ç…§ç‰‡
            await this.loadPhotos();
            this.render();
            
            EchoVerseHelpers.showToast(`æˆåŠŸå¯¼å…¥ ${files.length} å¼ ç…§ç‰‡`, 'success');
        };
        
        input.click();
    }
    
    // åˆ‡æ¢ç…§ç‰‡é€‰æ‹©
    togglePhotoSelection(photoId) {
        const index = this.selectedPhotos.indexOf(photoId);
        
        if (index === -1) {
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é€‰æ‹©æ•°é‡
            if (this.selectedPhotos.length >= this.maxSelection) {
                EchoVerseHelpers.showToast(`æœ€å¤šåªèƒ½é€‰æ‹© ${this.maxSelection} å¼ ç…§ç‰‡`, 'error');
                return;
            }
            this.selectedPhotos.push(photoId);
        } else {
            this.selectedPhotos.splice(index, 1);
        }
        
        // æ›´æ–°UI
        this.updateSelectionUI();
    }
    
    // æ›´æ–°é€‰æ‹©UI
    updateSelectionUI() {
        // æ›´æ–°é€‰æ‹©çŠ¶æ€
        const photoItems = this.container.querySelectorAll('.photo-item');
        photoItems.forEach(item => {
            const photoId = item.dataset.photoId;
            const selectionDiv = item.querySelector('.photo-selection');
            
            if (selectionDiv) {
                const isSelected = this.selectedPhotos.includes(photoId);
                selectionDiv.classList.toggle('selected', isSelected);
                selectionDiv.innerHTML = isSelected ? '<i class="fas fa-check"></i>' : '';
            }
        });
        
        // æ›´æ–°è®¡æ•°å™¨
        const countElement = this.container.querySelector('.selection-count');
        const confirmBtn = this.container.querySelector('#btn-confirm-selection');
        const selectBtn = this.container.querySelector('.btn-select');
        
        if (countElement) {
            countElement.textContent = `å·²é€‰æ‹© ${this.selectedPhotos.length}/${this.maxSelection} å¼ `;
        }
        
        if (confirmBtn) {
            confirmBtn.disabled = this.selectedPhotos.length === 0;
        }
        
        if (selectBtn) {
            selectBtn.disabled = this.selectedPhotos.length === 0;
        }
    }
    
    // ç¡®è®¤é€‰æ‹©
    confirmSelection() {
        if (this.selectedPhotos.length === 0) return;
        
        if (this.currentMode === 'wallpaper') {
            // è®¾ç½®ä¸ºå£çº¸
            const selectedPhoto = this.photos.find(p => p.id === this.selectedPhotos[0]);
            if (selectedPhoto) {
                // é€šçŸ¥ä¸»å±å¹•æ›´æ¢å£çº¸
                const event = new CustomEvent('setWallpaper', {
                    detail: {
                        type: 'image',
                        value: `url("${selectedPhoto.data}")`
                    }
                });
                document.dispatchEvent(event);
                
                EchoVerseHelpers.showToast('å£çº¸è®¾ç½®æˆåŠŸ', 'success');
                this.goBack();
            }
        } else if (this.currentMode === 'select') {
            // è¿”å›é€‰æ‹©ç»“æœ
            if (this.onSelectCallback) {
                const selectedPhotoData = this.photos.filter(p => 
                    this.selectedPhotos.includes(p.id)
                );
                this.onSelectCallback(selectedPhotoData);
            }
            
            // é‡ç½®æ¨¡å¼
            this.currentMode = 'browse';
            this.selectedPhotos = [];
            this.render();
        }
    }
    
    // æŸ¥çœ‹ç…§ç‰‡
    viewPhoto(photoId) {
        const photo = this.photos.find(p => p.id === photoId);
        if (!photo) return;
        
        const modalId = EchoVerseHelpers.createModal({
            title: '',
            content: `
                <div class="photo-viewer">
                    <img src="${photo.data}" class="photo-fullsize">
                    <div class="photo-actions">
                        <button class="btn btn-secondary" data-action="share">
                            <i class="fas fa-share"></i> åˆ†äº«
                        </button>
                        <button class="btn btn-danger" data-action="delete">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `,
            buttons: []
        });
        
        // ç»‘å®šæ“ä½œ
        setTimeout(() => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    
                    const action = btn.dataset.action;
                    
                    if (action === 'share') {
                        this.sharePhoto(photo);
                    } else if (action === 'delete') {
                        this.deletePhoto(photoId, modalId);
                    }
                });
            }
        }, 100);
    }
    
    // åˆ†äº«ç…§ç‰‡
    sharePhoto(photo) {
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å®ç°åˆ†äº«åŠŸèƒ½
        EchoVerseHelpers.showToast('åˆ†äº«åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­', 'info');
    }
    
    // åˆ é™¤ç…§ç‰‡
    async deletePhoto(photoId, modalId) {
        const confirmed = await EchoVerseHelpers.createModal({
            title: 'åˆ é™¤ç…§ç‰‡',
            content: 'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç¡®è®¤åˆ é™¤',
                    class: 'btn-danger',
                    onClick: async () => {
                        await EchoVerseStorage.delete('photos', photoId);
                        
                        // ä»æ•°ç»„ä¸­ç§»é™¤
                        const index = this.photos.findIndex(p => p.id === photoId);
                        if (index !== -1) {
                            this.photos.splice(index, 1);
                        }
                        
                        // ä»é€‰æ‹©ä¸­ç§»é™¤
                        const selectIndex = this.selectedPhotos.indexOf(photoId);
                        if (selectIndex !== -1) {
                            this.selectedPhotos.splice(selectIndex, 1);
                        }
                        
                        // å…³é—­æŸ¥çœ‹å™¨
                        EchoVerseHelpers.closeModal(modalId);
                        
                        // é‡æ–°æ¸²æŸ“
                        this.render();
                        
                        EchoVerseHelpers.showToast('ç…§ç‰‡å·²åˆ é™¤', 'success');
                    }
                }
            ]
        });
    }
}
// components/camera-app.js
class CameraApp {
    constructor() {
        this.container = null;
        this.videoElement = null;
        this.canvasElement = null;
        this.stream = null;
        this.isRecording = false;
        this.recordingTime = 0;
        this.recordingTimer = null;
        this.currentMode = 'photo'; // photo, video
        this.currentCamera = 'user'; // user, environment
        
        this.constraints = {
            video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
    }
    
    // åˆå§‹åŒ–ç›¸æœºåº”ç”¨
    async init(containerId = 'camera-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // å¯åŠ¨ç›¸æœº
        await this.startCamera();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // æ¸²æŸ“ç›¸æœºåº”ç”¨
    render() {
        this.container.innerHTML = `
            <div class="camera-container">
                <div class="camera-header">
                    <button class="btn-back">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="camera-title">ç›¸æœº</div>
                    <button class="btn-switch-camera" title="åˆ‡æ¢æ‘„åƒå¤´">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="camera-preview">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                
                <div class="camera-controls">
                    <div class="mode-switch">
                        <button class="mode-btn ${this.currentMode === 'photo' ? 'active' : ''}" 
                                data-mode="photo">
                            <i class="fas fa-camera"></i>
                            <span>ç…§ç‰‡</span>
                        </button>
                        <button class="mode-btn ${this.currentMode === 'video' ? 'active' : ''}" 
                                data-mode="video">
                            <i class="fas fa-video"></i>
                            <span>è§†é¢‘</span>
                        </button>
                    </div>
                    
                    <div class="capture-area">
                        <button class="btn-capture ${this.currentMode === 'video' && this.isRecording ? 'recording' : ''}"
                                id="btn-capture">
                            ${this.currentMode === 'video' && this.isRecording ? 
                                '<i class="fas fa-square"></i>' : 
                                '<i class="fas fa-circle"></i>'}
                        </button>
                    </div>
                    
                    <div class="recording-timer ${this.isRecording ? 'active' : ''}" id="recording-timer">
                        00:00
                    </div>
                </div>
                
                <div class="camera-gallery">
                    <button class="btn-gallery" id="btn-gallery">
                        <i class="fas fa-images"></i>
                    </button>
                </div>
            </div>
        `;
        
        this.videoElement = this.container.querySelector('#camera-video');
        this.canvasElement = this.container.querySelector('#camera-canvas');
    }
    
    // å¯åŠ¨ç›¸æœº
    async startCamera() {
        try {
            // åœæ­¢ä¹‹å‰çš„æµ
            if (this.stream) {
                this.stream.getTracks().forEach(track => track.stop());
            }
            
            // è·å–æ–°çš„åª’ä½“æµ
            this.stream = await navigator.mediaDevices.getUserMedia(this.constraints);
            
            if (this.videoElement) {
                this.videoElement.srcObject = this.stream;
                
                // ç­‰å¾…è§†é¢‘å¯ä»¥æ’­æ”¾
                await new Promise((resolve) => {
                    this.videoElement.onloadedmetadata = () => {
                        this.videoElement.play();
                        resolve();
                    };
                });
            }
        } catch (error) {
            console.error('æ— æ³•è®¿é—®ç›¸æœº:', error);
            EchoVerseHelpers.showToast('æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
            
            // æ˜¾ç¤ºé”™è¯¯ç•Œé¢
            this.showCameraError();
        }
    }
    
    // æ˜¾ç¤ºç›¸æœºé”™è¯¯
    showCameraError() {
        const preview = this.container.querySelector('.camera-preview');
        if (preview) {
            preview.innerHTML = `
                <div class="camera-error">
                    <div class="error-icon">ğŸ“·</div>
                    <div class="error-title">æ— æ³•è®¿é—®ç›¸æœº</div>
                    <div class="error-description">
                        è¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ï¼Œç¡®ä¿å·²å…è®¸è®¿é—®ç›¸æœº
                    </div>
                    <button class="btn btn-primary" id="btn-retry-camera">
                        é‡è¯•
                    </button>
                </div>
            `;
            
            // ç»‘å®šé‡è¯•æŒ‰é’®
            this.container.querySelector('#btn-retry-camera').addEventListener('click', () => {
                this.startCamera();
            });
        }
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // è¿”å›æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-back')) {
                this.goBack();
            }
        });
        
        // åˆ‡æ¢æ‘„åƒå¤´
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-switch-camera')) {
                this.switchCamera();
            }
        });
        
        // æ¨¡å¼åˆ‡æ¢
        this.container.addEventListener('click', (e) => {
            const modeBtn = e.target.closest('.mode-btn');
            if (modeBtn) {
                const mode = modeBtn.dataset.mode;
                this.switchMode(mode);
            }
        });
        
        // æ‹ç…§/å½•åƒæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('#btn-capture')) {
                if (this.currentMode === 'photo') {
                    this.capturePhoto();
                } else if (this.currentMode === 'video') {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                }
            }
        });
        
        // ç›¸å†ŒæŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('#btn-gallery')) {
                this.openGallery();
            }
        });
    }
    
    // è¿”å›
    goBack() {
        // åœæ­¢æ‰€æœ‰åª’ä½“æµ
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
        }
        
        // åœæ­¢å½•åˆ¶è®¡æ—¶å™¨
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
        
        // è¿”å›ä¸»å±å¹•
        const event = new CustomEvent('appOpen', {
            detail: { appId: 'launcher' }
        });
        document.dispatchEvent(event);
    }
    
    // åˆ‡æ¢æ‘„åƒå¤´
    switchCamera() {
        this.currentCamera = this.currentCamera === 'user' ? 'environment' : 'user';
        this.constraints.video.facingMode = this.currentCamera;
        this.startCamera();
    }
    
    // åˆ‡æ¢æ¨¡å¼
    switchMode(mode) {
        if (mode === this.currentMode) return;
        
        // å¦‚æœæ­£åœ¨å½•åƒï¼Œå…ˆåœæ­¢
        if (this.isRecording) {
            this.stopRecording();
        }
        
        this.currentMode = mode;
        
        // æ›´æ–°UI
        const modeBtns = this.container.querySelectorAll('.mode-btn');
        const captureBtn = this.container.querySelector('#btn-capture');
        const timer = this.container.querySelector('#recording-timer');
        
        modeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        if (captureBtn) {
            captureBtn.classList.remove('recording');
            captureBtn.innerHTML = mode === 'video' ? 
                '<i class="fas fa-circle"></i>' : 
                '<i class="fas fa-circle"></i>';
        }
        
        if (timer) {
            timer.classList.remove('active');
        }
    }
    
    // æ‹ç…§
    async capturePhoto() {
        if (!this.videoElement || !this.canvasElement) return;
        
        try {
            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ç›¸åŒ
            this.canvasElement.width = this.videoElement.videoWidth;
            this.canvasElement.height = this.videoElement.videoHeight;
            
            // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°canvas
            const context = this.canvasElement.getContext('2d');
            context.drawImage(this.videoElement, 0, 0);
            
            // è·å–å›¾ç‰‡æ•°æ®
            const photoData = this.canvasElement.toDataURL('image/jpeg', 0.9);
            const thumbnail = await EchoVerseHelpers.createThumbnail(photoData);
            
            // ä¿å­˜åˆ°ç›¸å†Œ
            const photo = await EchoVerseStorage.addPhoto({
                type: 'photo',
                data: photoData,
                thumbnail: thumbnail,
                width: this.canvasElement.width,
                height: this.canvasElement.height,
                source: 'camera'
            });
            
            // æ˜¾ç¤ºæ‹ç…§æˆåŠŸæ•ˆæœ
            this.showCaptureEffect();
            
            EchoVerseHelpers.showToast('ç…§ç‰‡å·²ä¿å­˜', 'success');
            
        } catch (error) {
            console.error('æ‹ç…§å¤±è´¥:', error);
            EchoVerseHelpers.showToast('æ‹ç…§å¤±è´¥', 'error');
        }
    }
    
    // æ˜¾ç¤ºæ‹ç…§æ•ˆæœ
    showCaptureEffect() {
        const preview = this.container.querySelector('.camera-preview');
        if (!preview) return;
        
        // æ·»åŠ é—ªå…‰æ•ˆæœ
        const flash = document.createElement('div');
        flash.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0.8;
            z-index: 10;
            pointer-events: none;
        `;
        
        preview.appendChild(flash);
        
        // æ¸éšåŠ¨ç”»
        let opacity = 0.8;
        const fadeOut = () => {
            opacity -= 0.1;
            flash.style.opacity = opacity;
            
            if (opacity > 0) {
                requestAnimationFrame(fadeOut);
            } else {
                if (flash.parentNode) {
                    flash.parentNode.removeChild(flash);
                }
            }
        };
        
        requestAnimationFrame(fadeOut);
    }
    
    // å¼€å§‹å½•åƒ
    async startRecording() {
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨MediaRecorder API
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ¨¡æ‹Ÿå½•åƒåŠŸèƒ½
        
        this.isRecording = true;
        this.recordingTime = 0;
        
        // æ›´æ–°UI
        const captureBtn = this.container.querySelector('#btn-capture');
        const timer = this.container.querySelector('#recording-timer');
        
        if (captureBtn) {
            captureBtn.classList.add('recording');
            captureBtn.innerHTML = '<i class="fas fa-square"></i>';
        }
        
        if (timer) {
            timer.classList.add('active');
            timer.textContent = '00:00';
        }
        
        // å¼€å§‹è®¡æ—¶
        this.recordingTimer = setInterval(() => {
            this.recordingTime++;
            
            const minutes = Math.floor(this.recordingTime / 60).toString().padStart(2, '0');
            const seconds = (this.recordingTime % 60).toString().padStart(2, '0');
            
            if (timer) {
                timer.textContent = `${minutes}:${seconds}`;
            }
            
            // æœ€é•¿å½•åˆ¶60ç§’
            if (this.recordingTime >= 60) {
                this.stopRecording();
            }
        }, 1000);
        
        EchoVerseHelpers.showToast('å¼€å§‹å½•åƒ', 'info');
    }
    
    // åœæ­¢å½•åƒ
    async stopRecording() {
        if (!this.isRecording) return;
        
        this.isRecording = false;
        
        // åœæ­¢è®¡æ—¶å™¨
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
        
        // æ›´æ–°UI
        const captureBtn = this.container.querySelector('#btn-capture');
        const timer = this.container.querySelector('#recording-timer');
        
        if (captureBtn) {
            captureBtn.classList.remove('recording');
            captureBtn.innerHTML = '<i class="fas fa-circle"></i>';
        }
        
        if (timer) {
            timer.classList.remove('active');
        }
        
        // æ¨¡æ‹Ÿä¿å­˜è§†é¢‘
        if (this.recordingTime > 1) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä¿å­˜è§†é¢‘æ–‡ä»¶
            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            EchoVerseHelpers.showToast(`å½•åƒå·²ä¿å­˜ (${this.recordingTime}ç§’)`, 'success');
        } else {
            EchoVerseHelpers.showToast('å½•åƒæ—¶é—´å¤ªçŸ­', 'warning');
        }
    }
    
    // æ‰“å¼€ç›¸å†Œ
    openGallery() {
        const event = new CustomEvent('appOpen', {
            detail: { appId: 'gallery' }
        });
        document.dispatchEvent(event);
    }
    
    // é”€æ¯
    destroy() {
        // åœæ­¢æ‰€æœ‰åª’ä½“æµ
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        // åœæ­¢å½•åˆ¶è®¡æ—¶å™¨
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
    }
}
// components/sms-app.js
class SMSApp {
    constructor() {
        this.container = null;
        this.conversations = [];
        this.currentConversation = null;
        this.messages = [];
        this.aiFriends = [];
    }
    
    // åˆå§‹åŒ–çŸ­ä¿¡åº”ç”¨
    async init(containerId = 'sms-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // åŠ è½½æ•°æ®
        await this.loadData();
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // åŠ è½½æ•°æ®
    async loadData() {
        // åŠ è½½AIå¥½å‹
        this.aiFriends = await EchoVerseStorage.getAIFriends();
        
        // æ„å»ºå¯¹è¯åˆ—è¡¨
        this.conversations = this.aiFriends.map(ai => ({
            id: `sms_${ai.id}`,
            aiId: ai.id,
            name: ai.profile.name,
            avatar: ai.profile.avatar,
            lastMessage: '',
            lastTime: ai.state.lastMessageTime,
            unread: 0
        }));
    }
    
    // æ¸²æŸ“çŸ­ä¿¡åº”ç”¨
    render() {
        const isConversationView = this.currentConversation !== null;
        
        this.container.innerHTML = `
            <div class="sms-container">
                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <div class="app-header">
                    <div class="header-left">
                        ${isConversationView ? `
                            <button class="btn-back">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="chat-title">
                                <div class="ai-avatar"></div>
                                <div class="ai-name"></div>
                            </div>
                        ` : `
                            <div class="app-title">çŸ­ä¿¡</div>
                        `}
                    </div>
                    <div class="header-right">
                        ${!isConversationView ? `
                            <button class="btn-new" title="æ–°çŸ­ä¿¡">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="sms-content">
                    ${isConversationView ? this.renderConversation() : this.renderConversationList()}
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                ${isConversationView ? this.renderInputArea() : ''}
            </div>
        `;
        
        // æ›´æ–°å¤´åƒå’Œåç§°
        if (isConversationView && this.currentConversation) {
            const ai = this.aiFriends.find(a => a.id === this.currentConversation.aiId);
            if (ai) {
                const avatarElement = this.container.querySelector('.ai-avatar');
                const nameElement = this.container.querySelector('.ai-name');
                
                if (avatarElement) {
                    avatarElement.innerHTML = this.renderAvatar(ai.profile.avatar, 'small');
                }
                
                if (nameElement) {
                    nameElement.textContent = ai.profile.name;
                }
            }
        }
    }
    
    // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
    renderConversationList() {
        if (this.conversations.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">æ²¡æœ‰çŸ­ä¿¡å¯¹è¯</div>
                    <div class="empty-description">é€‰æ‹©ä¸€ä¸ªAIå¥½å‹å¼€å§‹çŸ­ä¿¡èŠå¤©</div>
                </div>
            `;
        }
        
        return `
            <div class="sms-list">
                ${this.conversations.map(conv => this.renderConversationItem(conv)).join('')}
            </div>
        `;
    }
    
    // æ¸²æŸ“å¯¹è¯é¡¹ç›®
    renderConversationItem(conv) {
        const ai = this.aiFriends.find(a => a.id === conv.aiId);
        if (!ai) return '';
        
        const lastTime = conv.lastTime ? EchoVerseHelpers.formatTime(conv.lastTime) : '';
        
        return `
            <div class="sms-list-item" data-ai-id="${conv.aiId}">
                <div class="item-avatar">
                    ${this.renderAvatar(ai.profile.avatar, 'normal')}
                </div>
                <div class="item-content">
                    <div class="item-header">
                        <div class="item-name">${ai.profile.name}</div>
                        <div class="item-time">${lastTime}</div>
                    </div>
                    <div class="item-preview">
                        ${conv.lastMessage || 'è¿˜æ²¡æœ‰æ¶ˆæ¯'}
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“å¯¹è¯
    renderConversation() {
        if (!this.currentConversation) return '';
        
        return `
            <div class="sms-conversation">
                <div class="message-list" id="sms-message-list">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“è¾“å…¥åŒºåŸŸ
    renderInputArea() {
        if (!this.currentConversation) return '';
        
        return `
            <div class="sms-input-area">
                <div class="input-container">
                    <input type="text" 
                           class="sms-input" 
                           placeholder="è¾“å…¥çŸ­ä¿¡å†…å®¹..."
                           id="sms-input">
                    <button class="btn-send" title="å‘é€">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“å¤´åƒ
    renderAvatar(avatarData, size = 'normal') {
        const sizes = {
            small: '32px',
            normal: '48px',
            large: '80px'
        };
        
        const sizePx = sizes[size] || sizes.normal;
        
        if (avatarData.type === 'emoji') {
            return `
                <div class="avatar-emoji" style="
                    width: ${sizePx};
                    height: ${sizePx};
                    background-color: ${avatarData.backgroundColor};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: ${size === 'small' ? '14px' : '16px'};
                    color: white;
                    font-weight: bold;
                ">
                    ${avatarData.content}
                </div>
            `;
        } else {
            // é»˜è®¤å¤´åƒ
            const randomColor = EchoVerseHelpers.generateRandomColor();
            const letter = avatarData.content ? avatarData.content.charAt(0).toUpperCase() : 'A';
            
            return `
                <div class="avatar-default" style="
                    width: ${sizePx};
                    height: ${sizePx};
                    background-color: ${randomColor};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: ${size === 'small' ? '14px' : '16px'};
                    color: white;
                    font-weight: bold;
                ">
                    ${letter}
                </div>
            `;
        }
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // è¿”å›æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-back')) {
                this.goBackToList();
            }
        });
        
        // æ–°çŸ­ä¿¡æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-new')) {
                this.showNewSMSDialog();
            }
        });
        
        // å¯¹è¯åˆ—è¡¨é¡¹ç‚¹å‡»
        this.container.addEventListener('click', (e) => {
            const listItem = e.target.closest('.sms-list-item');
            if (listItem) {
                const aiId = listItem.dataset.aiId;
                this.openConversation(aiId);
            }
        });
        
        // å‘é€æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-send')) {
                this.sendSMS();
            }
        });
        
        // è¾“å…¥æ¡†å›è½¦å‘é€
        this.container.addEventListener('keydown', (e) => {
            if (e.target.id === 'sms-input' && e.key === 'Enter') {
                e.preventDefault();
                this.sendSMS();
            }
        });
    }
    
    // è¿”å›åˆ—è¡¨
    goBackToList() {
        this.currentConversation = null;
        this.messages = [];
        this.render();
    }
    
    // æ˜¾ç¤ºæ–°çŸ­ä¿¡å¯¹è¯æ¡†
    showNewSMSDialog() {
        if (this.aiFriends.length === 0) {
            EchoVerseHelpers.showToast('è¿˜æ²¡æœ‰AIå¥½å‹', 'error');
            return;
        }
        
        const items = this.aiFriends.map(ai => ({
            text: ai.profile.name,
            onClick: () => this.openConversation(ai.id)
        }));
        
        EchoVerseHelpers.createActionSheet({
            title: 'é€‰æ‹©æ”¶ä»¶äºº',
            items: items
        });
    }
    
    // æ‰“å¼€å¯¹è¯
    async openConversation(aiId) {
        const ai = this.aiFriends.find(a => a.id === aiId);
        if (!ai) return;
        
        this.currentConversation = {
            id: `sms_${aiId}`,
            aiId: aiId,
            name: ai.profile.name
        };
        
        // åŠ è½½æ¶ˆæ¯
        await this.loadMessages(aiId);
        
        // æ¸²æŸ“å¯¹è¯ç•Œé¢
        this.render();
        
        // æ¸²æŸ“æ¶ˆæ¯
        this.renderMessages();
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        this.scrollToBottom();
    }
    
    // åŠ è½½æ¶ˆæ¯
    async loadMessages(aiId) {
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»å­˜å‚¨ä¸­åŠ è½½çŸ­ä¿¡æ¶ˆæ¯
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        this.messages = [
            {
                id: 'sms_1',
                sender: 'user',
                content: 'ä½ å¥½ï¼è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€æ¡çŸ­ä¿¡',
                timestamp: Date.now() - 3600000,
                type: 'text'
            },
            {
                id: 'sms_2',
                sender: `ai_${aiId}`,
                content: 'æ”¶åˆ°ä½ çš„çŸ­ä¿¡äº†ï¼æˆ‘æ˜¯é€šè¿‡çŸ­ä¿¡å’Œä½ èŠå¤©çš„AI',
                timestamp: Date.now() - 1800000,
                type: 'text'
            },
            {
                id: 'sms_3',
                sender: 'user',
                content: 'çŸ­ä¿¡èŠå¤©å’Œæ™®é€šèŠå¤©æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ',
                timestamp: Date.now() - 900000,
                type: 'text'
            },
            {
                id: 'sms_4',
                sender: `ai_${aiId}`,
                content: 'çŸ­ä¿¡æ˜¯ç‹¬ç«‹çš„èŠå¤©ç³»ç»Ÿï¼Œæ¶ˆæ¯ä¸ä¼šå’Œæ™®é€šèŠå¤©æ··åœ¨ä¸€èµ·ï¼Œè€Œä¸”æ²¡æœ‰å‘é€é™åˆ¶å“¦ï¼',
                timestamp: Date.now() - 300000,
                type: 'text'
            }
        ];
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    renderMessages() {
        const messageList = this.container.querySelector('#sms-message-list');
        if (!messageList) return;
        
        messageList.innerHTML = '';
        
        this.messages.forEach(message => {
            const isAI = message.sender.startsWith('ai_');
            const messageElement = this.createMessageElement(message, isAI);
            messageList.appendChild(messageElement);
        });
        
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤º
        if (this.messages.length === 0) {
            messageList.innerHTML = `
                <div class="empty-messages">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">è¿˜æ²¡æœ‰çŸ­ä¿¡</div>
                    <div class="empty-description">å‘é€ç¬¬ä¸€æ¡çŸ­ä¿¡å¼€å§‹å¯¹è¯å§</div>
                </div>
            `;
        }
    }
    
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    createMessageElement(message, isAI) {
        const time = EchoVerseHelpers.formatMessageTime(message.timestamp);
        
        return `
            <div class="sms-message ${isAI ? 'message-left' : 'message-right'}">
                <div class="message-bubble ${isAI ? 'bubble-left' : 'bubble-right'}">
                    ${message.content}
                </div>
                <div class="message-time">${time}</div>
            </div>
        `;
    }
    
    // å‘é€çŸ­ä¿¡
    async sendSMS() {
        if (!this.currentConversation) return;
        
        const input = this.container.querySelector('#sms-input');
        if (!input) return;
        
        const content = input.value.trim();
        if (!content) return;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        const userMessage = {
            id: `sms_${Date.now()}`,
            sender: 'user',
            content: content,
            timestamp: Date.now(),
            type: 'text'
        };
        
        this.messages.push(userMessage);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        
        // æ›´æ–°æ˜¾ç¤º
        this.renderMessages();
        this.scrollToBottom();
        
        // AIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
        setTimeout(() => {
            this.sendAIResponse();
        }, 1000);
    }
    
    // å‘é€AIå›å¤
    async sendAIResponse() {
        if (!this.currentConversation) return;
        
        const responses = [
            'æ”¶åˆ°ä½ çš„çŸ­ä¿¡äº†ï¼',
            'çŸ­ä¿¡å·²è¯»ï¼Œæ­£åœ¨æ€è€ƒå›å¤...',
            'è¿™æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„è¯é¢˜ï¼',
            'é€šè¿‡çŸ­ä¿¡èŠå¤©æ„Ÿè§‰çœŸä¸é”™',
            'éšæ—¶å¯ä»¥ç»™æˆ‘å‘çŸ­ä¿¡å“¦'
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        const aiMessage = {
            id: `sms_${Date.now()}_ai`,
            sender: `ai_${this.currentConversation.aiId}`,
            content: randomResponse,
            timestamp: Date.now(),
            type: 'text'
        };
        
        this.messages.push(aiMessage);
        
        // æ›´æ–°æ˜¾ç¤º
        this.renderMessages();
        this.scrollToBottom();
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
        const messageList = this.container.querySelector('#sms-message-list');
        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }
    }
}
// components/settings-app.js
class SettingsApp {
    constructor() {
        this.container = null;
        this.user = null;
        this.settings = null;
    }
    
    // åˆå§‹åŒ–è®¾ç½®åº”ç”¨
    async init(containerId = 'settings-app') {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        
        // åŠ è½½æ•°æ®
        await this.loadData();
        
        // æ¸²æŸ“åº”ç”¨
        this.render();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }
    
    // åŠ è½½æ•°æ®
    async loadData() {
        this.user = await EchoVerseStorage.getUser();
        this.settings = this.user.settings;
    }
    
    // æ¸²æŸ“è®¾ç½®åº”ç”¨
    render() {
        this.container.innerHTML = `
            <div class="settings-container">
                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <div class="app-header">
                    <div class="header-left">
                        <button class="btn-back">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="app-title">è®¾ç½®</div>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·ä¿¡æ¯ -->
                <div class="user-profile">
                    <div class="profile-avatar">
                        ${this.renderUserAvatar()}
                    </div>
                    <div class="profile-info">
                        <div class="profile-name">${this.user.profile.nickname}</div>
                        <div class="profile-id">ID: ${this.user.profile.echoId}</div>
                    </div>
                </div>
                
                <!-- è®¾ç½®åˆ—è¡¨ -->
                <div class="settings-list">
                    <div class="settings-section">
                        <div class="section-title">è´¦æˆ·è®¾ç½®</div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ‘¤</div>
                                <div class="item-text">
                                    <div class="item-title">ä¿®æ”¹æ˜µç§°</div>
                                    <div class="item-description">${this.user.profile.nickname}</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ†”</div>
                                <div class="item-text">
                                    <div class="item-title">ä¿®æ”¹ID</div>
                                    <div class="item-description">æ¯æœˆå¯ä¿®æ”¹ä¸€æ¬¡</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">é€šçŸ¥è®¾ç½®</div>
                        
                        <div class="settings-item toggle-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ””</div>
                                <div class="item-text">
                                    <div class="item-title">æ¶ˆæ¯é€šçŸ¥</div>
                                    <div class="item-description">æ¥æ”¶æ–°æ¶ˆæ¯æé†’</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-notifications" 
                                           ${this.settings.notifications ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-item toggle-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ‘ï¸</div>
                                <div class="item-text">
                                    <div class="item-title">æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€</div>
                                    <div class="item-description">è®©AIå¥½å‹çœ‹åˆ°ä½ åœ¨çº¿</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-online-status" 
                                           ${this.settings.privacy.showOnlineStatus ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-item toggle-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ¤–</div>
                                <div class="item-text">
                                    <div class="item-title">AIä¸»åŠ¨è”ç³»</div>
                                    <div class="item-description">å…è®¸AIä¸»åŠ¨å‘é€æ¶ˆæ¯</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-ai-initiate" 
                                           ${this.settings.privacy.allowAIInitiate ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">æ•°æ®ç®¡ç†</div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ’¾</div>
                                <div class="item-text">
                                    <div class="item-title">å¤‡ä»½æ•°æ®</div>
                                    <div class="item-description">å¯¼å‡ºæ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ“¥</div>
                                <div class="item-text">
                                    <div class="item-title">æ¢å¤æ•°æ®</div>
                                    <div class="item-description">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ—‘ï¸</div>
                                <div class="item-text">
                                    <div class="item-title">æ¸…é™¤ç¼“å­˜</div>
                                    <div class="item-description">é‡Šæ”¾å­˜å‚¨ç©ºé—´</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">å…³äº</div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">â„¹ï¸</div>
                                <div class="item-text">
                                    <div class="item-title">ç‰ˆæœ¬ä¿¡æ¯</div>
                                    <div class="item-description">EchoVerse v1.0.0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ“„</div>
                                <div class="item-text">
                                    <div class="item-title">ç”¨æˆ·åè®®</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="item-content">
                                <div class="item-icon">ğŸ”’</div>
                                <div class="item-text">
                                    <div class="item-title">éšç§æ”¿ç­–</div>
                                </div>
                            </div>
                            <div class="item-action">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“ç”¨æˆ·å¤´åƒ
    renderUserAvatar() {
        if (this.user.profile.avatar) {
            return `<img src="${this.user.profile.avatar}" class="avatar-image">`;
        } else {
            const firstLetter = this.user.profile.nickname.charAt(0).toUpperCase();
            const randomColor = EchoVerseHelpers.generateRandomColor();
            
            return `
                <div class="avatar-default" style="
                    width: 60px;
                    height: 60px;
                    background-color: ${randomColor};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    color: white;
                    font-weight: bold;
                ">
                    ${firstLetter}
                </div>
            `;
        }
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // è¿”å›æŒ‰é’®
        this.container.addEventListener('click', (e) => {
            if (e.target.closest('.btn-back')) {
                this.goBack();
            }
        });
        
        // åˆ‡æ¢å¼€å…³
        this.container.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                this.handleToggleChange(e.target);
            }
        });
        
        // è®¾ç½®é¡¹ç‚¹å‡»
        this.container.addEventListener('click', (e) => {
            const settingsItem = e.target.closest('.settings-item:not(.toggle-item)');
            if (settingsItem) {
                const itemTitle = settingsItem.querySelector('.item-title')?.textContent;
                this.handleSettingsClick(itemTitle);
            }
        });
    }
    
    // è¿”å›
    goBack() {
        const event = new CustomEvent('appOpen', {
            detail: { appId: 'launcher' }
        });
        document.dispatchEvent(event);
    }
    
    // å¤„ç†åˆ‡æ¢å¼€å…³å˜åŒ–
    async handleToggleChange(checkbox) {
        const settingId = checkbox.id;
        const isChecked = checkbox.checked;
        
        let updates = {};
        
        switch(settingId) {
            case 'toggle-notifications':
                updates = { notifications: isChecked };
                break;
                
            case 'toggle-online-status':
                updates = { 
                    privacy: {
                        ...this.settings.privacy,
                        showOnlineStatus: isChecked
                    }
                };
                break;
                
            case 'toggle-ai-initiate':
                updates = {
                    privacy: {
                        ...this.settings.privacy,
                        allowAIInitiate: isChecked
                    }
                };
                break;
        }
        
        if (Object.keys(updates).length > 0) {
            this.settings = { ...this.settings, ...updates };
            await EchoVerseStorage.updateUser({ settings: this.settings });
            
            EchoVerseHelpers.showToast('è®¾ç½®å·²ä¿å­˜', 'success');
        }
    }
    
    // å¤„ç†è®¾ç½®é¡¹ç‚¹å‡»
    handleSettingsClick(itemTitle) {
        switch(itemTitle) {
            case 'ä¿®æ”¹æ˜µç§°':
                this.changeNickname();
                break;
                
            case 'ä¿®æ”¹ID':
                this.changeEchoId();
                break;
                
            case 'å¤‡ä»½æ•°æ®':
                this.backupData();
                break;
                
            case 'æ¢å¤æ•°æ®':
                this.restoreData();
                break;
                
            case 'æ¸…é™¤ç¼“å­˜':
                this.clearCache();
                break;
                
            case 'ç”¨æˆ·åè®®':
                this.showUserAgreement();
                break;
                
            case 'éšç§æ”¿ç­–':
                this.showPrivacyPolicy();
                break;
        }
    }
    
    // ä¿®æ”¹æ˜µç§°
    async changeNickname() {
        const modalId = EchoVerseHelpers.createModal({
            title: 'ä¿®æ”¹æ˜µç§°',
            content: `
                <input type="text" 
                       class="input-field" 
                       id="new-nickname" 
                       value="${this.user.profile.nickname}"
                       placeholder="è¯·è¾“å…¥æ–°æ˜µç§°"
                       maxlength="20">
                <div class="input-hint">æ˜µç§°æœ€å¤š20ä¸ªå­—ç¬¦</div>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ä¿å­˜',
                    class: 'btn-primary',
                    onClick: async () => {
                        const newNickname = document.getElementById('new-nickname').value.trim();
                        
                        if (!newNickname) {
                            EchoVerseHelpers.showToast('æ˜µç§°ä¸èƒ½ä¸ºç©º', 'error');
                            return;
                        }
                        
                        if (newNickname === this.user.profile.nickname) {
                            EchoVerseHelpers.showToast('æ˜µç§°æ²¡æœ‰å˜åŒ–', 'info');
                            EchoVerseHelpers.closeModal(modalId);
                            return;
                        }
                        
                        await EchoVerseStorage.updateUser({
                            profile: {
                                ...this.user.profile,
                                nickname: newNickname
                            }
                        });
                        
                        EchoVerseHelpers.showToast('æ˜µç§°ä¿®æ”¹æˆåŠŸ', 'success');
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        EchoVerseHelpers.closeModal(modalId);
                        
                        // é‡æ–°åŠ è½½æ•°æ®å¹¶åˆ·æ–°
                        await this.loadData();
                        this.render();
                    }
                }
            ]
        });
    }
    
    // ä¿®æ”¹ID
    async changeEchoId() {
        const now = Date.now();
        const lastChanged = this.user.profile.echoIdLastChanged || 0;
        const daysSinceLastChange = (now - lastChanged) / (1000 * 60 * 60 * 24);
        
        if (daysSinceLastChange < 30) {
            const daysLeft = Math.ceil(30 - daysSinceLastChange);
            EchoVerseHelpers.showToast(`æ¯æœˆåªèƒ½ä¿®æ”¹ä¸€æ¬¡IDï¼Œè¿˜éœ€ç­‰å¾… ${daysLeft} å¤©`, 'error');
            return;
        }
        
        const modalId = EchoVerseHelpers.createModal({
            title: 'ä¿®æ”¹ID',
            content: `
                <p>å½“å‰ID: <strong>${this.user.profile.echoId}</strong></p>
                <p>IDæ¯æœˆåªèƒ½ä¿®æ”¹ä¸€æ¬¡ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
                <input type="text" 
                       class="input-field" 
                       id="new-echo-id" 
                       placeholder="è¯·è¾“å…¥æ–°ID (å­—æ¯å’Œæ•°å­—ï¼Œæœ€å¤š11ä½)"
                       maxlength="11"
                       pattern="[A-Za-z0-9]+">
                <div class="input-hint">åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œæœ€å¤š11ä½</div>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç”ŸæˆéšæœºID',
                    class: 'btn-secondary',
                    onClick: () => {
                        const newId = EchoVerseStorage.generateEchoId();
                        document.getElementById('new-echo-id').value = newId;
                    }
                },
                {
                    text: 'ç¡®è®¤ä¿®æ”¹',
                    class: 'btn-primary',
                    onClick: async () => {
                        const newEchoId = document.getElementById('new-echo-id').value.trim();
                        
                        if (!newEchoId) {
                            EchoVerseHelpers.showToast('IDä¸èƒ½ä¸ºç©º', 'error');
                            return;
                        }
                        
                        if (!/^[A-Za-z0-9]+$/.test(newEchoId)) {
                            EchoVerseHelpers.showToast('IDåªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
                            return;
                        }
                        
                        if (newEchoId.length > 11) {
                            EchoVerseHelpers.showToast('IDæœ€å¤š11ä½', 'error');
                            return;
                        }
                        
                        if (newEchoId === this.user.profile.echoId) {
                            EchoVerseHelpers.showToast('IDæ²¡æœ‰å˜åŒ–', 'info');
                            EchoVerseHelpers.closeModal(modalId);
                            return;
                        }
                        
                        await EchoVerseStorage.updateUser({
                            profile: {
                                ...this.user.profile,
                                echoId: newEchoId,
                                echoIdLastChanged: now
                            }
                        });
                        
                        EchoVerseHelpers.showToast('IDä¿®æ”¹æˆåŠŸ', 'success');
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        EchoVerseHelpers.closeModal(modalId);
                        
                        // é‡æ–°åŠ è½½æ•°æ®å¹¶åˆ·æ–°
                        await this.loadData();
                        this.render();
                    }
                }
            ]
        });
    }
    
    // å¤‡ä»½æ•°æ®
    async backupData() {
        try {
            const data = await EchoVerseStorage.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = url;
            a.download = `EchoVerse_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // é‡Šæ”¾URL
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            EchoVerseHelpers.showToast('å¤‡ä»½æˆåŠŸï¼Œæ–‡ä»¶å·²å¼€å§‹ä¸‹è½½', 'success');
            
        } catch (error) {
            console.error('å¤‡ä»½å¤±è´¥:', error);
            EchoVerseHelpers.showToast('å¤‡ä»½å¤±è´¥', 'error');
        }
    }
    
    // æ¢å¤æ•°æ®
    async restoreData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                
                const confirmed = await EchoVerseHelpers.createModal({
                    title: 'ç¡®è®¤æ¢å¤',
                    content: `
                        <p style="color: var(--danger-red); font-weight: bold;">
                            è­¦å‘Šï¼šæ¢å¤æ•°æ®å°†è¦†ç›–æ‰€æœ‰ç°æœ‰æ•°æ®ï¼
                        </p>
                        <p>è¯·ç¡®è®¤å·²å¤‡ä»½å½“å‰æ•°æ®ã€‚</p>
                        <p>æ–‡ä»¶å: ${file.name}</p>
                        <p>å¤§å°: ${(file.size / 1024).toFixed(2)} KB</p>
                    `,
                    buttons: [
                        {
                            text: 'å–æ¶ˆ',
                            class: 'btn-secondary',
                            action: 'close'
                        },
                        {
                            text: 'ç¡®è®¤æ¢å¤',
                            class: 'btn-danger',
                            onClick: async () => {
                                try {
                                    await EchoVerseStorage.importData(text);
                                    EchoVerseHelpers.showToast('æ•°æ®æ¢å¤æˆåŠŸ', 'success');
                                    
                                    // é‡æ–°åŠ è½½é¡µé¢
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1000);
                                    
                                } catch (error) {
                                    console.error('æ¢å¤å¤±è´¥:', error);
                                    EchoVerseHelpers.showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
                                }
                            }
                        }
                    ]
                });
                
            } catch (error) {
                console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
                EchoVerseHelpers.showToast('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
            }
        };
        
        input.click();
    }
    
    // æ¸…é™¤ç¼“å­˜
    async clearCache() {
        const confirmed = await EchoVerseHelpers.createModal({
            title: 'æ¸…é™¤ç¼“å­˜',
            content: `
                <p>æ¸…é™¤ç¼“å­˜å°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š</p>
                <ul style="padding-left: 20px; margin: 10px 0;">
                    <li>ä¸´æ—¶æ–‡ä»¶</li>
                    <li>å›¾ç‰‡ç¼“å­˜</li>
                    <li>æ—¥å¿—æ–‡ä»¶</li>
                </ul>
                <p style="color: var(--info-blue);">
                    æ³¨æ„ï¼šç”¨æˆ·æ•°æ®ã€èŠå¤©è®°å½•ç­‰ä¸ä¼šè¢«åˆ é™¤ã€‚
                </p>
            `,
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'æ¸…é™¤ç¼“å­˜',
                    class: 'btn-primary',
                    onClick: () => {
                        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ¸…ç†ç¼“å­˜
                        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        EchoVerseHelpers.showToast('ç¼“å­˜å·²æ¸…é™¤', 'success');
                    }
                }
            ]
        });
    }
    
    // æ˜¾ç¤ºç”¨æˆ·åè®®
    showUserAgreement() {
        const modalId = EchoVerseHelpers.createModal({
            title: 'ç”¨æˆ·åè®®',
            content: `
                <div style="max-height: 300px; overflow-y: auto; padding: 10px;">
                    <h3>EchoVerse ç”¨æˆ·åè®®</h3>
                    <p>æ¬¢è¿ä½¿ç”¨EchoVerseï¼è¯·åœ¨å¼€å§‹ä½¿ç”¨å‰ä»”ç»†é˜…è¯»ä»¥ä¸‹æ¡æ¬¾ã€‚</p>
                    
                    <h4>1. æœåŠ¡è¯´æ˜</h4>
                    <p>EchoVerseæ˜¯ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„è™šæ‹Ÿæ‰‹æœºåº”ç”¨ï¼Œæä¾›AIç¤¾äº¤ã€è™šæ‹Ÿå•†åº—ç­‰åŠŸèƒ½ã€‚</p>
                    
                    <h4>2. ç”¨æˆ·è´£ä»»</h4>
                    <p>ç”¨æˆ·éœ€å¯¹ä½¿ç”¨æœ¬åº”ç”¨çš„è¡Œä¸ºè´Ÿè´£ï¼Œä¸å¾—è¿›è¡Œä»»ä½•è¿æ³•æˆ–ä¾µçŠ¯ä»–äººæƒç›Šçš„è¡Œä¸ºã€‚</p>
                    
                    <h4>3. æ•°æ®éšç§</h4>
                    <p>æ‰€æœ‰ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šæ”¶é›†ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚</p>
                    
                    <h4>4. å…è´£å£°æ˜</h4>
                    <p>æœ¬åº”ç”¨æŒ‰"ç°çŠ¶"æä¾›ï¼Œä¸æä¾›ä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è¯ã€‚</p>
                    
                    <p style="margin-top: 20px; color: var(--text-secondary);">
                        æœ€åæ›´æ–°ï¼š2024å¹´3æœˆ
                    </p>
                </div>
            `,
            buttons: [
                {
                    text: 'å…³é—­',
                    class: 'btn-primary',
                    action: 'close'
                }
            ]
        });
    }
    
    // æ˜¾ç¤ºéšç§æ”¿ç­–
    showPrivacyPolicy() {
        const modalId = EchoVerseHelpers.createModal({
            title: 'éšç§æ”¿ç­–',
            content: `
                <div style="max-height: 300px; overflow-y: auto; padding: 10px;">
                    <h3>EchoVerse éšç§æ”¿ç­–</h3>
                    <p>æˆ‘ä»¬éå¸¸é‡è§†æ‚¨çš„éšç§ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„éšç§æ”¿ç­–è¯´æ˜ï¼š</p>
                    
                    <h4>1. æ•°æ®å­˜å‚¨</h4>
                    <p>æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆèŠå¤©è®°å½•ã€ç…§ç‰‡ã€è®¾ç½®ç­‰ï¼‰éƒ½å­˜å‚¨åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</p>
                    <p>æˆ‘ä»¬ä¸ä¼šåœ¨æœåŠ¡å™¨ä¸Šå­˜å‚¨ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚</p>
                    
                    <h4>2. æ•°æ®è®¿é—®</h4>
                    <p>åº”ç”¨ä»…åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šå°†æ•°æ®ä¼ è¾“åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
                    
                    <h4>3. ç›¸æœºå’Œç›¸å†Œè®¿é—®</h4>
                    <p>è®¿é—®ç›¸æœºå’Œç›¸å†Œéœ€è¦æ‚¨çš„æ˜ç¡®æˆæƒï¼Œæ‰€æœ‰æ‹æ‘„å’Œå¯¼å…¥çš„ç…§ç‰‡éƒ½å­˜å‚¨åœ¨æœ¬åœ°ã€‚</p>
                    
                    <h4>4. ç¬¬ä¸‰æ–¹API</h4>
                    <p>å½“æ‚¨ä½¿ç”¨å¤–éƒ¨AI APIæ—¶ï¼Œç›¸å…³æ•°æ®ä¼šå‘é€åˆ°å¯¹åº”çš„APIæä¾›å•†ï¼Œè¯·å‚è€ƒå…¶éšç§æ”¿ç­–ã€‚</p>
                    
                    <h4>5. æ•°æ®å¤‡ä»½</h4>
                    <p>æˆ‘ä»¬æä¾›æ•°æ®å¤‡ä»½åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥å°†æ•°æ®å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ï¼Œå®Œå…¨ç”±æ‚¨æ§åˆ¶ã€‚</p>
                    
                    <p style="margin-top: 20px; color: var(--text-secondary);">
                        æœ€åæ›´æ–°ï¼š2024å¹´3æœˆ
                    </p>
                </div>
            `,
            buttons: [
                {
                    text: 'å…³é—­',
                    class: 'btn-primary',
                    action: 'close'
                }
            ]
        });
    }
}

// app.js
const EchoVerse = {
    // ç»„ä»¶å®ä¾‹
    statusBar: null,
    launcher: null,
    chatApp: null,
    storeApp: null,
    galleryApp: null,
    cameraApp: null,
    smsApp: null,
    settingsApp: null,
    
    // å½“å‰æ´»åŠ¨åº”ç”¨
    activeApp: null,
    
    // åˆå§‹åŒ–åº”ç”¨
    async init() {
        console.log('EchoVerse æ­£åœ¨å¯åŠ¨...');
        
        try {
            // åˆå§‹åŒ–å­˜å‚¨
            await EchoVerseStorage.init();
            console.log('å­˜å‚¨ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            
            // åˆå§‹åŒ–çŠ¶æ€æ 
            this.statusBar = new StatusBar();
            await this.statusBar.init();
            
            // åˆå§‹åŒ–ä¸»å±å¹•
            this.launcher = new Launcher();
            await this.launcher.init();
            
            // åˆå§‹åŒ–å…¶ä»–åº”ç”¨ï¼ˆæ‡’åŠ è½½ï¼‰
            this.chatApp = new ChatApp();
            this.storeApp = new StoreApp();
            this.galleryApp = new GalleryApp();
            this.cameraApp = new CameraApp();
            this.smsApp = new SMSApp();
            this.settingsApp = new SettingsApp();
            
            // è®¾ç½®ä¸»å±å¹•ä¸ºæ´»åŠ¨åº”ç”¨
            this.activeApp = 'launcher';
            
            // ç»‘å®šå…¨å±€äº‹ä»¶
            this.bindGlobalEvents();
            
            // è®¾ç½®ç”¨æˆ·æœ€åæ´»åŠ¨æ—¶é—´
            localStorage.setItem('echoVerse_lastActive', Date.now());
            
            // å®šæœŸæ›´æ–°æ´»åŠ¨æ—¶é—´
            setInterval(() => {
                localStorage.setItem('echoVerse_lastActive', Date.now());
            }, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            
            console.log('EchoVerse å¯åŠ¨å®Œæˆ');
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                EchoVerseHelpers.showToast('EchoVerse å·²å°±ç»ªï¼', 'success');
            }, 1000);
            
        } catch (error) {
            console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
            this.showInitError(error);
        }
    },
    
    // ç»‘å®šå…¨å±€äº‹ä»¶
    bindGlobalEvents() {
        // åº”ç”¨æ‰“å¼€äº‹ä»¶
        document.addEventListener('appOpen', (e) => {
            const appId = e.detail.appId;
            this.switchApp(appId);
        });
        
        // è®¾ç½®å£çº¸äº‹ä»¶
        document.addEventListener('setWallpaper', (e) => {
            if (this.launcher) {
                this.launcher.changeWallpaper(e.detail.type, e.detail.value);
            }
        });
        
        // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šå…³é—­æ‰€æœ‰æµ®å±‚
        document.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»äº†æ¨¡æ€æ¡†å®¹å™¨ä½†æ²¡æœ‰ç‚¹å‡»æ¨¡æ€æ¡†å†…å®¹ï¼Œä¸å¤„ç†
            if (e.target.id === 'modal-container') {
                // æ¸…ç©ºæ¨¡æ€æ¡†å®¹å™¨
                e.target.innerHTML = '';
            }
        });
        
        // å…¨å±€é”®ç›˜äº‹ä»¶ï¼šè¿”å›é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.handleBackButton();
            }
        });
        
        // é˜²æ­¢å³é”®èœå•
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.app-container')) {
                e.preventDefault();
            }
        });
    },
    
    // åˆ‡æ¢åº”ç”¨
    async switchApp(appId) {
        console.log(`åˆ‡æ¢åˆ°åº”ç”¨: ${appId}`);
        
        // å¦‚æœå·²ç»åœ¨ç›®æ ‡åº”ç”¨ï¼Œä¸å¤„ç†
        if (this.activeApp === appId) return;
        
        // å¤„ç†å½“å‰æ´»åŠ¨åº”ç”¨
        if (this.activeApp) {
            await this.deactivateApp(this.activeApp);
        }
        
        // æ¿€æ´»æ–°åº”ç”¨
        await this.activateApp(appId);
        
        this.activeApp = appId;
    },
    
    // æ¿€æ´»åº”ç”¨
    async activateApp(appId) {
        const appElement = document.getElementById(`${appId}-app`);
        if (!appElement) return;
        
        // æ˜¾ç¤ºåº”ç”¨
        appElement.classList.remove('hidden');
        appElement.classList.add('active');
        
        // åˆå§‹åŒ–åº”ç”¨ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼‰
        switch(appId) {
            case 'chat':
                await this.chatApp.init();
                break;
            case 'store':
                await this.storeApp.init();
                break;
            case 'gallery':
                await this.galleryApp.init();
                break;
            case 'camera':
                await this.cameraApp.init();
                break;
            case 'sms':
                await this.smsApp.init();
                break;
            case 'settings':
                await this.settingsApp.init();
                break;
        }
    },
    
    // åœç”¨åº”ç”¨
    async deactivateApp(appId) {
        const appElement = document.getElementById(`${appId}-app`);
        if (!appElement) return;
        
        // éšè—åº”ç”¨
        appElement.classList.remove('active');
        appElement.classList.add('hidden');
        
        // æ¸…ç†åº”ç”¨èµ„æº
        switch(appId) {
            case 'camera':
                if (this.cameraApp) {
                    this.cameraApp.destroy();
                }
                break;
        }
    },
    
    // å¤„ç†è¿”å›æŒ‰é’®
    handleBackButton() {
        if (this.activeApp === 'launcher') {
            // åœ¨ä¸»å±å¹•ï¼Œæ˜¾ç¤ºé€€å‡ºç¡®è®¤
            this.showExitConfirm();
        } else {
            // åœ¨å…¶ä»–åº”ç”¨ï¼Œè¿”å›åˆ°ä¸»å±å¹•
            const event = new CustomEvent('appOpen', {
                detail: { appId: 'launcher' }
            });
            document.dispatchEvent(event);
        }
    },
    
    // æ˜¾ç¤ºé€€å‡ºç¡®è®¤
    showExitConfirm() {
        EchoVerseHelpers.createModal({
            title: 'é€€å‡ºåº”ç”¨',
            content: 'ç¡®å®šè¦ç¦»å¼€EchoVerseå—ï¼Ÿ',
            buttons: [
                {
                    text: 'å–æ¶ˆ',
                    class: 'btn-secondary',
                    action: 'close'
                },
                {
                    text: 'ç¡®è®¤é€€å‡º',
                    class: 'btn-primary',
                    onClick: () => {
                        // åœ¨å®é™…çš„Webåº”ç”¨ä¸­ï¼Œå¯èƒ½æ— æ³•çœŸæ­£"é€€å‡º"
                        // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ„Ÿè°¢ä¿¡æ¯æˆ–åˆ·æ–°é¡µé¢
                        EchoVerseHelpers.showToast('æ„Ÿè°¢ä½¿ç”¨EchoVerseï¼', 'success');
                        
                        // å¦‚æœæ˜¯å…¨å±æ¨¡å¼ï¼Œå¯ä»¥é€€å‡ºå…¨å±
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                    }
                }
            ]
        });
    },
    
    // æ˜¾ç¤ºåˆå§‹åŒ–é”™è¯¯
    showInitError(error) {
        document.body.innerHTML = `
            <div style="
                width: 100vw;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                font-family: 'Inter', sans-serif;
                text-align: center;
                padding: 20px;
            ">
                <div>
                    <h1 style="font-size: 48px; margin-bottom: 20px;">ğŸ˜¢</h1>
                    <h2 style="margin-bottom: 10px;">åº”ç”¨åˆå§‹åŒ–å¤±è´¥</h2>
                    <p style="margin-bottom: 20px; opacity: 0.8;">
                        ${error.message || 'æœªçŸ¥é”™è¯¯'}
                    </p>
                    <p style="margin-bottom: 30px; font-size: 14px;">
                        è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯
                    </p>
                    <button onclick="window.location.reload()" 
                            style="
                                background: white;
                                color: #667eea;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                        é‡è¯•
                    </button>
                </div>
            </div>
        `;
    }
};
    <script>
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            EchoVerse.init();
        });
    </script>
</body>
</html>
